<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Learning to design RNA, internship in NC State Univ.">
<title>Deep Learning attempt for RNA inverse design.</title>

<link rel='canonical' href='https://mosfish.github.io/p/deep-learning-attempt-for-rna-inverse-design./'>

<link rel="stylesheet" href="/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css"><meta property='og:title' content="Deep Learning attempt for RNA inverse design.">
<meta property='og:description' content="Learning to design RNA, internship in NC State Univ.">
<meta property='og:url' content='https://mosfish.github.io/p/deep-learning-attempt-for-rna-inverse-design./'>
<meta property='og:site_name' content='Mosfish&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-06-04T15:36:23&#43;08:00'/><meta property='article:modified_time' content='2025-06-04T15:36:23&#43;08:00'/>
<meta name="twitter:title" content="Deep Learning attempt for RNA inverse design.">
<meta name="twitter:description" content="Learning to design RNA, internship in NC State Univ.">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/head_hu_6dccde155e9615c8.gif" width="300"
                            height="275" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Mosfish&#39;s Blog</a></h1>
            <h2 class="site-description">I still feel like it has something to do with those fries on the pier.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='mailto:wenxy59@mail2.sysu.edu.cn'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" /><path d="M3 7l9 6l9 -6" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/Mosfish'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://mosfish.github.io/'
                        target="_blank"
                        title="Homepage"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-building-bank"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 21l18 0" /><path d="M3 10l18 0" /><path d="M5 6l7 -3l7 3" /><path d="M4 10l0 11" /><path d="M20 10l0 11" /><path d="M8 14l0 3" /><path d="M12 14l0 3" /><path d="M16 14l0 3" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.linkedin.com/in/xiangyuwen-mosfish/'
                        target="_blank"
                        title="Linkedin"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 11v5" /><path d="M8 8v.01" /><path d="M12 16v-5" /><path d="M16 16v-3a2 2 0 1 0 -4 0" /><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z" /></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页 | Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='https://wenxy59.github.io/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于 | About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档 | Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索 | Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E6%8A%80%E6%9C%AF%E9%93%BE%E6%8E%A5friends-links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>技术链接&amp;friends | Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#remote-server-initialization-operations">Remote server initialization operations</a>
      <ol>
        <li><a href="#mirror-source-acceleration">Mirror source acceleration</a></li>
        <li><a href="#environment">Environment</a></li>
      </ol>
    </li>
    <li><a href="#when-we-training-the-model">When we training the model</a>
      <ol>
        <li><a href="#data-pre-process">Data pre-process</a></li>
      </ol>
    </li>
    <li><a href="#reproduce-the-authors-result">Reproduce the author&rsquo;s result</a></li>
    <li><a href="#another-way-diffusion-model-like-ribodiffusion-ridiffusion-diffrnafold-etc">Another way: Diffusion Model like RiboDiffusion, RIdiffusion, DiffRNAfold .etc</a>
      <ol>
        <li><a href="#ribodiffusion">RiboDiffusion</a></li>
      </ol>
    </li>
    <li><a href="#simple-method-for-grnade">Simple method for gRNAde</a>
      <ol>
        <li><a href="#one-simple-attention-layer-added-to-the-model">One simple attention layer added to the model</a>
          <ol>
            <li><a href="#get-our-first-model">Get our first model</a></li>
          </ol>
        </li>
        <li><a href="#multi-layer-attention-or-multihead-attention">Multi-layer attention or multihead attention?</a></li>
        <li><a href="#data-leakage-issue-came-up">Data leakage issue came up</a></li>
      </ol>
    </li>
    <li><a href="#optimization-methods-and-experiments">Optimization methods and experiments</a>
      <ol>
        <li><a href="#graph-mamba">Graph-Mamba</a>
          <ol>
            <li><a href="#mamba">Mamba</a></li>
            <li><a href="#graph-mamba-towards-long-range-graph-sequence-modeling-withselective-state-spaces">Graph-Mamba: Towards Long-Range Graph Sequence Modeling withSelective State Spaces</a></li>
          </ol>
        </li>
        <li><a href="#long-short-transformer-and-graph-long-short-transformer">Long-Short Transformer and Graph Long-Short Transformer</a></li>
        <li><a href="#gat-gvp-long-short-graph-transformer">GAT-GVP long-short graph transformer</a></li>
        <li><a href="#experiments">Experiments</a>
          <ol>
            <li><a href="#learning-rate">Learning rate</a></li>
            <li><a href="#comparison">Comparison</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#other-paper-reading">Other Paper Reading</a>
      <ol>
        <li><a href="#a-hyperbolic-discrete-diffusion-3d-rna-inverse-folding-model-for-functional-rna-design">A Hyperbolic Discrete Diffusion 3D RNA Inverse Folding Model for functional RNA design。</a>
          <ol>
            <li><a href="#abstractintroduction">Abstract&amp;Introduction</a></li>
            <li><a href="#about-the-model">about the model</a></li>
            <li><a href="#materials-and-methods">MATERIALS AND METHODS</a></li>
            <li><a href="#datasets-and-setup">Datasets and Setup</a></li>
            <li><a href="#evaluation-metrics">Evaluation Metrics</a></li>
            <li><a href="#baselines">Baselines</a></li>
            <li><a href="#results">Results</a></li>
          </ol>
        </li>
        <li><a href="#beyond-rna-structure-alone-complex-aware-feature-fusion-for-tertiary-structure-based-rna-design">Beyond RNA Structure Alone: Complex-Aware Feature Fusion for Tertiary Structure-based RNA Design</a>
          <ol>
            <li><a href="#abstract">Abstract</a></li>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#methods">Methods</a></li>
            <li><a href="#experiments-1">Experiments</a></li>
          </ol>
        </li>
        <li><a href="#ribodiffusion-tertiary-structure-based-rna-inverse-folding-with-generative-diffusion-models">RiboDiffusion: tertiary structure-based RNA inverse folding with generative diffusion models</a></li>
        <li><a href="#learning-to-design-rna">Learning to Design RNA</a></li>
        <li><a href="#rna-dcgen-dual-constrained-rna-sequence-generation-with-llm-attack"><strong>RNA-DCGen: Dual Constrained RNA Sequence</strong> Generation with LLM-Attack</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/ai4s/" style="background-color: #800020; color: #fff;">
                AI4S
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/deep-learning-attempt-for-rna-inverse-design./">Deep Learning attempt for RNA inverse design.</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Learning to design RNA, internship in NC State Univ.
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 04, 2025</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="attempt-to-build-a-long-range-specific-model">Attempt to build a Long-Range specific model
</h1><p>I feel excited to begin my research internship in NC State. Considering the outstanding article:</p>
<p><strong>gRNAde: Geometric Deep Learning for 3D RNA Inverse Design</strong>.</p>
<p>This paper is clear and friendly to such &ldquo;rookie&rdquo; like me. Besides, it&rsquo;s easy to reproduce and the source code is released at:</p>
<p><a class="link" href="https://github.com/chaitjo/geometric-rna-design"  target="_blank" rel="noopener"
    >https://github.com/chaitjo/geometric-rna-design</a></p>
<h2 id="remote-server-initialization-operations">Remote server initialization operations
</h2><p>For convenience, I rent the GPU server from AutoDL: <a class="link" href="https://www.autodl.com/"  target="_blank" rel="noopener"
    >https://www.autodl.com/</a>, and my friend let me use his RTX4090 in U.K.</p>
<p>However, servers in China and UK need different settings. For the AutoDL Server, I need to use the data disk <strong>autodl-tmp</strong> more instead of the system disk, for the limited memory of system disk.</p>
<p>But, that leads to a problem: if use the data disk more, the CPU’s data reading and processing become slower because the <strong>data disk is cloud-based</strong>, which causes <strong>low GPU utilization</strong> (like on an RTX 5090). So it depends.</p>
<p>The author required the environment as follows:</p>
<blockquote>
<p>Python 3.10.12 and CUDA 11.8, numpy &lt;2.0</p>
</blockquote>
<p>In fact, we need python=3.10 and CUDA 12.8(for RTX5090).</p>
<h3 id="mirror-source-acceleration">Mirror source acceleration
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">git clone https://ghfast.top/github.com/chaitjo/geometric-rna-design.git
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cd /root/autodl-tmp/geometric-rna-design
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="environment">Environment
</h3><p>If our system disk doesn’t have enough space, let&rsquo; s:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mamba create -p /root/autodl-tmp/rna python=3.10
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mamba activate /root/autodl-tmp/rna
</span></span></code></pre></td></tr></table>
</div>
</div><p>And we can clean rubbish:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">pip cache purge
</span></span><span class="line"><span class="cl">conda clean --all
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>For current shell, we have the followings. It is suggested that we can add it to <code>bashrc</code> or <code>.env</code> file, then <code>source ~/.bashrc</code>.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PROJECT_PATH</span><span class="o">=</span><span class="s1">&#39;/root/autodl-tmp/geometric-rna-design/&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">ETERNAFOLD</span><span class="o">=</span><span class="s1">&#39;/root/autodl-tmp/geometric-rna-design/tools/EternaFold&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">X3DNA</span><span class="o">=</span><span class="s1">&#39;/root/autodl-tmp/geometric-rna-design/tools/x3dna-v2.4&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&#34;/root/autodl-tmp/geometric-rna-design/tools/x3dna-v2.4/bin:$PATH&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&#34;/root/autodl-tmp/cdhit:$PATH&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PYTORCH_CUDA_ALLOC_CONF</span><span class="o">=</span><span class="n">max_split_size_mb</span><span class="p">:</span><span class="mi">128</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For UK server, this is mine:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PROJECT_PATH</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">DATA_PATH</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/data/&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">WANDB_PROJECT</span><span class="o">=</span><span class="s1">&#39;rna&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">WANDB_ENTITY</span><span class="o">=</span><span class="s1">&#39;wenxy59-sun-yat-sen-university&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">WANDB_DIR</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">ETERNAFOLD</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/tools/EternaFold&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">X3DNA</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/tools/x3dna-v2.4&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&#34;/home/remote1/geometric-rna-design/tools/x3dna-v2.4/bin:$PATH&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PYTORCH_CUDA_ALLOC_CONF</span><span class="o">=</span><span class="n">max_split_size_mb</span><span class="p">:</span><span class="mi">128</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="when-we-training-the-model">When we training the model
</h2><h3 id="data-pre-process">Data pre-process
</h3><p>Before we start, we need to run the <code>process_data.py</code> and obtain the <code>process.pt</code> , and then run the notebook to get <code>das_split.pt</code>.</p>
<p>In the progress, we need <code>USalign&amp;qTMclust</code>,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#Install CD-HIT for sequence identity clustering</span>
</span></span><span class="line"><span class="cl"><span class="n">mamba</span> <span class="n">install</span> <span class="n">cd</span><span class="o">-</span><span class="n">hit</span> <span class="o">-</span><span class="n">c</span> <span class="n">bioconda</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Install US-align/qTMclust for structural similarity clustering</span>
</span></span><span class="line"><span class="cl"><span class="n">cd</span> <span class="o">~/</span><span class="n">geometric</span><span class="o">-</span><span class="n">rna</span><span class="o">-</span><span class="n">design</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">pylelab</span><span class="o">/</span><span class="n">USalign</span><span class="o">.</span><span class="n">git</span> <span class="o">&amp;&amp;</span> <span class="n">cd</span> <span class="n">USalign</span><span class="o">/</span> <span class="o">&amp;&amp;</span> <span class="n">git</span> <span class="n">checkout</span> <span class="mi">97325</span><span class="n">d3aad852f8a4407649f25e697bbaa17e186</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span><span class="o">++</span> <span class="o">-</span><span class="n">static</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">ffast</span><span class="o">-</span><span class="n">math</span> <span class="o">-</span><span class="n">lm</span> <span class="o">-</span><span class="n">o</span> <span class="n">USalign</span> <span class="n">USalign</span><span class="o">.</span><span class="n">cpp</span>
</span></span><span class="line"><span class="cl"><span class="n">g</span><span class="o">++</span> <span class="o">-</span><span class="n">static</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">ffast</span><span class="o">-</span><span class="n">math</span> <span class="o">-</span><span class="n">lm</span> <span class="o">-</span><span class="n">o</span> <span class="n">qTMclust</span> <span class="n">qTMclust</span><span class="o">.</span><span class="n">cpp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># (Optional) Install ViennaRNA, mainly used for plotting in design notebook</span>
</span></span><span class="line"><span class="cl"><span class="n">cd</span> <span class="o">~/</span><span class="n">geometric</span><span class="o">-</span><span class="n">rna</span><span class="o">-</span><span class="n">design</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">tar</span> <span class="o">-</span><span class="n">zxvf</span> <span class="n">ViennaRNA</span><span class="o">-</span><span class="mf">2.6.4</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</span></span><span class="line"><span class="cl"><span class="n">cd</span> <span class="n">ViennaRNA</span><span class="o">-</span><span class="mf">2.6.4</span>
</span></span><span class="line"><span class="cl"><span class="o">./</span><span class="n">configure</span>  <span class="c1"># ./configure --enable-macosx-installer</span>
</span></span><span class="line"><span class="cl"><span class="n">make</span>
</span></span><span class="line"><span class="cl"><span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After that, we can make a validation by<code>USalign -h</code> and <code>qTMclust -h</code>. Pay attention to your path, such as <code>src/data/clustering_units.py</code></p>
<div align=center><img src="1.png" width=400/></div>
<center><font size=2>Successfully process the data</font></center>
<p>We will skip any RNA molecules whose structural data are incomplete once we find out.</p>
<div align=center><img src="2.png" width=400/></div>
<center><font size=2>problem data</font></center>
<h2 id="reproduce-the-authors-result">Reproduce the author&rsquo;s result
</h2><p>The author offered an <code>.py</code> file or we can start by command like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">python gRNAde.py     --pdb_filepath data/raw/6J6G_1_L-E.pdb     --output_filepath tutorial/lnc/po/114.fasta     --split das     --max_num_conformers 1  --n_samples 16     --temperature 0.5
</span></span></code></pre></td></tr></table>
</div>
</div><div align=center><img src="3.png" width=400/></div>
<center><font size=2>let's run gRNAde</font></center>
<p>We then test it on the whole RNASolo Dataset(both train and test) first as a rough experiment. The model’s performance drops when dealing with long RNA sequences (over 100 nts). Although the recovery drops a little, the self-consistency score for secondary structure (SC Score) shows a clear linear decline.</p>
<div align=center><img src="6.png" width=600/></div>
<center><font size=2>comparison metircs</font></center>
<div align=center><img src="4.png" width=300/><img src="5.png" width=300/></div>
<center><font size=2>SC Score(left) and Recovery(right) with Sequence</font></center>
<h2 id="another-way-diffusion-model-like-ribodiffusion-ridiffusion-diffrnafold-etc">Another way: Diffusion Model like RiboDiffusion, RIdiffusion, DiffRNAfold .etc
</h2><h3 id="ribodiffusion">RiboDiffusion
</h3><p>To reproduce RiboDiffusion, we can set the environment like this on the RTX4090:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">rna2</span> <span class="n">python</span><span class="o">=</span><span class="mf">3.10</span> <span class="o">-</span><span class="n">y</span>
</span></span><span class="line"><span class="cl"><span class="n">conda</span> <span class="n">activate</span> <span class="n">rna2</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">==</span><span class="mf">1.13</span><span class="o">.</span><span class="mi">1</span><span class="o">+</span><span class="n">cu116</span> <span class="n">torchvision</span><span class="o">==</span><span class="mf">0.14</span><span class="o">.</span><span class="mi">1</span><span class="o">+</span><span class="n">cu116</span> <span class="n">torchaudio</span><span class="o">==</span><span class="mf">0.13</span><span class="o">.</span><span class="mi">1</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="n">url</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">whl</span><span class="o">/</span><span class="n">cu116</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">absl</span><span class="o">-</span><span class="n">py</span><span class="o">==</span><span class="mf">0.15</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">biopython</span><span class="o">==</span><span class="mf">1.80</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">dm_tree</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">7</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">fair</span><span class="o">-</span><span class="n">esm</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">ml_collections</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">numpy</span><span class="o">==</span><span class="mf">1.24</span><span class="o">.</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">scipy</span><span class="o">&gt;=</span><span class="mf">1.10</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">tqdm</span><span class="o">==</span><span class="mf">4.64</span><span class="o">.</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">-</span><span class="n">cluster</span><span class="o">==</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">1</span><span class="o">+</span><span class="n">pt113cu116</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">pyg</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">whl</span><span class="o">/</span><span class="n">torch</span><span class="o">-</span><span class="mf">1.13</span><span class="o">.</span><span class="mi">0</span><span class="o">+</span><span class="n">cu116</span><span class="o">.</span><span class="n">html</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">-</span><span class="n">scatter</span><span class="o">==</span><span class="mf">2.1</span><span class="o">.</span><span class="mi">1</span><span class="o">+</span><span class="n">pt113cu116</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">pyg</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">whl</span><span class="o">/</span><span class="n">torch</span><span class="o">-</span><span class="mf">1.13</span><span class="o">.</span><span class="mi">0</span><span class="o">+</span><span class="n">cu116</span><span class="o">.</span><span class="n">html</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">-</span><span class="n">geometric</span><span class="o">==</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Although we can run it well and it shows a promising way to generate RNA Molecules, maybe there are some problems. Let&rsquo;s look at the picture below, the recovery rate(you can understand it like &ldquo;accuracy&rdquo;) will often comes to 100%! And it drops up and down which seems no clear pattern.</p>
<div align=center><img src="7.png" width=400/></div>
<center><font size=2>RiboDiffusion输出</font></center>
<p>To solve my confuse, I test it with RNASolo Data set(manually), but it seemed that is not obvious.</p>
<div align=center><img src="8.png" width=400/></div>
<div align=center><img src="9.png" width=400/></div>
<center><font size=2>RiboDiffusion,Recovery in log(up) and normal(down) drops with Sequence</font></center>
<p>We will follow the scripts as:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">diffusion</span> <span class="kn">import</span> <span class="n">NoiseScheduleVP</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sampling</span> <span class="kn">import</span> <span class="n">get_sampling_fn</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">du</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">functools</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tree</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">configs.inference_ribodiffusion</span> <span class="kn">import</span> <span class="n">get_config</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Choose heckpoint name</span>
</span></span><span class="line"><span class="cl"><span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s1">&#39;./ckpts/exp_inf.pth&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># checkpoint_path = &#39;./ckpts/exp_inf_large.pth&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="c1"># config.eval.sampling_steps = 100</span>
</span></span><span class="line"><span class="cl"><span class="n">NUM_TO_LETTER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_optimizer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;&#34;&#34;Return a flax optimizer object based on `config`.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;Adam&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">beta1</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;AdamW&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">amsgrad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimizer </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span><span class="si">}</span><span class="s1"> not supported yet!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">optimizer</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize model</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ema</span> <span class="o">=</span> <span class="n">ExponentialMovingAverage</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ema_decay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">optimizer</span> <span class="o">=</span> <span class="n">get_optimizer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">ema</span><span class="o">=</span><span class="n">ema</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">model_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model size: </span><span class="si">{:.1f}</span><span class="s1">MB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Load checkpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">state</span> <span class="o">=</span> <span class="n">restore_checkpoint</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ema</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize noise scheduler</span>
</span></span><span class="line"><span class="cl"><span class="n">noise_scheduler</span> <span class="o">=</span> <span class="n">NoiseScheduleVP</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">schedule</span><span class="p">,</span> <span class="n">continuous_beta_0</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">continuous_beta_0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">continuous_beta_1</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">continuous_beta_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Obtain data scalar and inverse scalar</span>
</span></span><span class="line"><span class="cl"><span class="n">inverse_scaler</span> <span class="o">=</span> <span class="n">get_data_inverse_scaler</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup sampling function</span>
</span></span><span class="line"><span class="cl"><span class="n">test_sampling_fn</span> <span class="o">=</span> <span class="n">get_sampling_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">noise_scheduler</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span><span class="p">,</span> <span class="n">inverse_scaler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb2data</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">du</span><span class="o">.</span><span class="n">PDBtoData</span><span class="p">,</span> <span class="n">num_posenc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_posenc</span><span class="p">,</span> <span class="n">num_rbf</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_rbf</span><span class="p">,</span> <span class="n">knn_num</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">knn_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Run inference on a single p</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb_file</span><span class="o">=</span> <span class="s1">&#39;/home/remote1/geometric-rna-design/data/raw/1FIR_1_A.pdb&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb_id</span> <span class="o">=</span> <span class="n">pdb_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.pdb&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">pdb_id</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdb_id</span> <span class="o">=</span> <span class="n">pdb_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">dynamic_threshold</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">cond_scale</span><span class="o">=</span><span class="mf">0.4</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl"><span class="n">test_sampling_fn</span> <span class="o">=</span> <span class="n">get_sampling_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">noise_scheduler</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span><span class="p">,</span> <span class="n">inverse_scaler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">struct_data</span> <span class="o">=</span> <span class="n">pdb2data</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">struct_data</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map_structure</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">struct_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">samples</span> <span class="o">=</span> <span class="n">test_sampling_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">struct_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PDB ID: </span><span class="si">{</span><span class="n">pdb_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">native_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">NUM_TO_LETTER</span><span class="p">[</span><span class="n">struct_data</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Native sequence: </span><span class="si">{</span><span class="n">native_seq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># native_seq = &#39;&#39;.join(list(NUM_TO_LETTER[struct_data[&#39;seq&#39;].squeeze(0).cpu().numpy()]))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(f&#39;Native sequence: {native_seq}&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">designed_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">NUM_TO_LETTER</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]))</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated sequence </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">designed_seq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">recovery_</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">struct_data</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Recovery rate </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">recovery_</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, too slow, too tired, and I design a automatic scripts like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add the gRNAde path to import evaluation tools</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/remote1/geometric-rna-design/src&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/remote1/geometric-rna-design/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">diffusion</span> <span class="kn">import</span> <span class="n">NoiseScheduleVP</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sampling</span> <span class="kn">import</span> <span class="n">get_sampling_fn</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">du</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">functools</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tree</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">configs.inference_ribodiffusion</span> <span class="kn">import</span> <span class="n">get_config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Import gRNAde evaluation functions</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">src.evaluator</span> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">self_consistency_score_eternafold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit_distance</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">src.data.data_utils</span> <span class="kn">import</span> <span class="n">pdb_to_tensor</span><span class="p">,</span> <span class="n">get_c4p_coords</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">src.constants</span> <span class="kn">import</span> <span class="n">NUM_TO_LETTER</span><span class="p">,</span> <span class="n">PROJECT_PATH</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Import BioPython for sequence handling</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Bio</span> <span class="kn">import</span> <span class="n">SeqIO</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Bio.Seq</span> <span class="kn">import</span> <span class="n">Seq</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Bio.SeqRecord</span> <span class="kn">import</span> <span class="n">SeqRecord</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Choose checkpoint name</span>
</span></span><span class="line"><span class="cl"><span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s1">&#39;./ckpts/exp_inf.pth&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_optimizer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Return a flax optimizer object based on `config`.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;Adam&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">beta1</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                              <span class="n">eps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;AdamW&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">amsgrad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimizer </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span><span class="si">}</span><span class="s1"> not supported yet!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">optimizer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_sec_struct_from_pdb</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Extract secondary structure from PDB file using gRNAde&#39;s data utilities.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequence</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">sec_struct</span><span class="p">,</span> <span class="n">sasa</span> <span class="o">=</span> <span class="n">pdb_to_tensor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">pdb_file</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">return_sec_struct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">return_sasa</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">keep_insertions</span><span class="o">=</span><span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">sec_struct</span><span class="p">]</span> <span class="k">if</span> <span class="n">sec_struct</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Warning: Could not extract secondary structure from </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">prepare_raw_data_for_grnade_eval</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">,</span> <span class="n">native_seq</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Prepare raw data structure compatible with gRNAde evaluator.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequence</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">sec_struct</span><span class="p">,</span> <span class="n">sasa</span> <span class="o">=</span> <span class="n">pdb_to_tensor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">pdb_file</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">return_sec_struct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">return_sasa</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">keep_insertions</span><span class="o">=</span><span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">raw_data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">native_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;coords_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">coords</span><span class="p">]</span> <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sec_struct_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">sec_struct</span><span class="p">]</span> <span class="k">if</span> <span class="n">sec_struct</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&#34;.&#34;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sasa_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">sasa</span><span class="p">]</span> <span class="k">if</span> <span class="n">sasa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">raw_data</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Warning: Could not prepare raw data from </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Return minimal raw data structure</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">native_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;coords_list&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sec_struct_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;.&#34;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sasa_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">evaluate_ribodiffusion_with_grnade_sc</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">native_seq</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">,</span> <span class="n">pdb_id</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                         <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Evaluate RiboDiffusion samples using gRNAde&#39;s self-consistency evaluation.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Prepare raw data for gRNAde evaluator</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">prepare_raw_data_for_grnade_eval</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">,</span> <span class="n">native_seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert RiboDiffusion samples to numpy arrays</span>
</span></span><span class="line"><span class="cl">    <span class="n">sample_arrays</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">sample_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sample_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create mask for coordinates (assume all positions are valid for now)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate basic metrics</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;pdb_id&#39;</span><span class="p">:</span> <span class="n">pdb_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;native_seq&#39;</span><span class="p">:</span> <span class="n">native_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;samples&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;recovery_rates&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;edit_distances&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert native sequence to numerical for recovery calculation</span>
</span></span><span class="line"><span class="cl">    <span class="n">letter_to_num</span> <span class="o">=</span> <span class="p">{</span><span class="n">letter</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">letter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">NUM_TO_LETTER</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">    <span class="n">native_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">letter_to_num</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">native_seq</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Evaluating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples for </span><span class="si">{</span><span class="n">pdb_id</span><span class="si">}</span><span class="s2">:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample_array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_arrays</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">designed_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">NUM_TO_LETTER</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">sample_array</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">designed_seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculate recovery rate</span>
</span></span><span class="line"><span class="cl">        <span class="n">recovery</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_array</span> <span class="o">==</span> <span class="n">native_array</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;recovery_rates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculate edit distance using gRNAde&#39;s function</span>
</span></span><span class="line"><span class="cl">        <span class="n">edit_dist</span> <span class="o">=</span> <span class="n">edit_distance</span><span class="p">(</span><span class="n">designed_seq</span><span class="p">,</span> <span class="n">native_seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;edit_distances&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edit_dist</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">: Recovery=</span><span class="si">{</span><span class="n">recovery</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, Edit_dist=</span><span class="si">{</span><span class="n">edit_dist</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate self-consistency scores using gRNAde&#39;s EternaFold evaluator</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Calculating self-consistency scores with EternaFold...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sc_scores</span> <span class="o">=</span> <span class="n">self_consistency_score_eternafold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">sample_arrays</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;sec_struct_list&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mask_coords</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc_scores</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sc_score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sc_scores</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">: SC_score=</span><span class="si">{</span><span class="n">sc_score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Warning: Could not calculate SC scores: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;This might be due to EternaFold not being properly installed or configured.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Save results</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">save_results</span> <span class="ow">and</span> <span class="n">output_dir</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Save as FASTA file compatible with gRNAde format</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequences</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># First record: input sequence with metadata</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SeqRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Seq</span><span class="p">(</span><span class="n">native_seq</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">            <span class="nb">id</span><span class="o">=</span><span class="s2">&#34;input_sequence,&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;pdb_id=</span><span class="si">{</span><span class="n">pdb_id</span><span class="si">}</span><span class="s2">, ribodiffusion_evaluation&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Remaining records: designed sequences with metrics</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">recovery</span><span class="p">,</span> <span class="n">edit_dist</span><span class="p">,</span> <span class="n">sc_score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;recovery_rates&#39;</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;edit_distances&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SeqRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">Seq</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;sample=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">,&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;recovery=</span><span class="si">{</span><span class="n">recovery</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, edit_dist=</span><span class="si">{</span><span class="n">edit_dist</span><span class="si">}</span><span class="s2">, sc_score=</span><span class="si">{</span><span class="n">sc_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Save FASTA</span>
</span></span><span class="line"><span class="cl">        <span class="n">fasta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">pdb_id</span><span class="si">}</span><span class="s2">_ribodiffusion_designs.fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SeqIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">fasta_path</span><span class="p">,</span> <span class="s2">&#34;fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Results saved to: </span><span class="si">{</span><span class="n">fasta_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Print summary statistics</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Summary for </span><span class="si">{</span><span class="n">pdb_id</span><span class="si">}</span><span class="s2">:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Native sequence length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Number of samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Mean Recovery: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;recovery_rates&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;recovery_rates&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Mean Edit Distance: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;edit_distances&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;edit_distances&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Mean SC Score (EternaFold): </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;SC Scores not calculated (EternaFold unavailable)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize model</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ema</span> <span class="o">=</span> <span class="n">ExponentialMovingAverage</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ema_decay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">optimizer</span> <span class="o">=</span> <span class="n">get_optimizer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">ema</span><span class="o">=</span><span class="n">ema</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">model_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model size: </span><span class="si">{:.1f}</span><span class="s1">MB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Load checkpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">state</span> <span class="o">=</span> <span class="n">restore_checkpoint</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ema</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize noise scheduler</span>
</span></span><span class="line"><span class="cl"><span class="n">noise_scheduler</span> <span class="o">=</span> <span class="n">NoiseScheduleVP</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">schedule</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                 <span class="n">continuous_beta_0</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">continuous_beta_0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">continuous_beta_1</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">continuous_beta_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Obtain data scalar and inverse scalar</span>
</span></span><span class="line"><span class="cl"><span class="n">inverse_scaler</span> <span class="o">=</span> <span class="n">get_data_inverse_scaler</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup sampling function</span>
</span></span><span class="line"><span class="cl"><span class="n">test_sampling_fn</span> <span class="o">=</span> <span class="n">get_sampling_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">noise_scheduler</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span><span class="p">,</span> <span class="n">inverse_scaler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb2data</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">du</span><span class="o">.</span><span class="n">PDBtoData</span><span class="p">,</span> <span class="n">num_posenc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_posenc</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">num_rbf</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_rbf</span><span class="p">,</span> <span class="n">knn_num</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">knn_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run inference</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb_file</span> <span class="o">=</span> <span class="s1">&#39;/home/remote1/geometric-rna-design/data/raw/7PIC_1_5.pdb&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.pdb&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Configure sampling</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">dynamic_threshold</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">cond_scale</span> <span class="o">=</span> <span class="mf">0.4</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Generate samples</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing PDB: </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">test_sampling_fn</span> <span class="o">=</span> <span class="n">get_sampling_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">noise_scheduler</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span><span class="p">,</span> <span class="n">inverse_scaler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">struct_data</span> <span class="o">=</span> <span class="n">pdb2data</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">struct_data</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map_structure</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">    <span class="n">struct_data</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">samples</span> <span class="o">=</span> <span class="n">test_sampling_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">struct_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get native sequence</span>
</span></span><span class="line"><span class="cl"><span class="n">native_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">NUM_TO_LETTER</span><span class="p">[</span><span class="n">struct_data</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Native sequence: </span><span class="si">{</span><span class="n">native_seq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create output directory</span>
</span></span><span class="line"><span class="cl"><span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;ribodiffusion_grnade_eval_</span><span class="si">{</span><span class="n">current_time</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Evaluate with gRNAde&#39;s self-consistency framework</span>
</span></span><span class="line"><span class="cl"><span class="n">results</span> <span class="o">=</span> <span class="n">evaluate_ribodiffusion_with_grnade_sc</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">native_seq</span><span class="o">=</span><span class="n">native_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdb_file</span><span class="o">=</span><span class="n">pdb_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdb_id</span><span class="o">=</span><span class="n">pdb_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Well, let&rsquo; s run it with almost 13000 data to test the actually performance, and we got:</p>
<div align=center><img src="21.png" width=400/></div>
<center><font size=2>Just do it!</font></center>
<div align=center><img src="19.png" width=400/><img src="20.png" width=400/></div>
<center><font size=2>result and result（after log）</font></center>
<p>Oh, actually, diffusion model is like buying a lottery ticket. Well, well, well, let&rsquo;s move on towards geometirc or Large Language Model.</p>
<h2 id="simple-method-for-grnade">Simple method for gRNAde
</h2><h3 id="one-simple-attention-layer-added-to-the-model">One simple attention layer added to the model
</h3><p>Since <strong>multi-layer attention mechanisms</strong> can help <strong>capture long sequences</strong>, I began by using <code>MultiheadAttention</code> and added a simple layer <strong>after the encoder and before the pooling set in the whole model</strong> for training. The original released code had some bugs, especially in the masking logic of the <code>mask_coords</code> function — it often caused dimension mismatches with the samples and threw errors. I’ve pasted my modified <code>evaluator.py</code> here. Also, to prevent GPU memory overflow, you’ll need to set the batch size properly.</p>
<p>A simple attention，<code>models.py</code> is here:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">        <span class="c1">#code before, Encoder layers (supports multiple conformations)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">MultiGVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#######################################</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Simple self-attention on pooled scalar node features, our changes</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">embed_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="c1">###########################################</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Decoder layers</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the forward, we add:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_multi_conf</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">###########################################################</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply simple self-attention over nodes (sequence length = n_nodes)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">need_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">attn_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="c1">##########################################################</span>
</span></span><span class="line"><span class="cl">        <span class="n">encoder_embeddings</span> <span class="o">=</span> <span class="n">h_V</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>and in the sample forward,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_multi_conf</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#############################################</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply simple self-attention over nodes (sequence length = n_nodes)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">need_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">attn_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">############################################</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since it’s usually hard to access wandb from local servers, and the original code relies heavily on wandb-related paths, I had to change the paths in <code>trainer.py</code>,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;xpu&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">intel_extension_for_pytorch</span> <span class="k">as</span> <span class="nn">ipex</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">ipex</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#=======same as before=======</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Initialise save directory</span>
</span></span><span class="line"><span class="cl">    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&#34;..&#34;</span><span class="p">,</span> <span class="s2">&#34;mymodel&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#save_dir = os.path.abspath(save_dir) or you can use this  </span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And we need to replace <code>wandb.run.dir</code> path to <code>save_dir</code>. Besides, we use <strong>autoaggresive</strong> as default.</p>
<p>When we wanna train it, let&rsquo; s keep it moving:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">nohup python main.py --no_wandb &gt; main.log 2&gt;&amp;1 &amp;
</span></span><span class="line"><span class="cl">tail -f main.log
</span></span><span class="line"><span class="cl">nvidia-smi
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="get-our-first-model">Get our first model
</h4><p>We finally get<code>best_checkpoint.h5</code> as the trained model，then, following the <code>gRNAde.py</code>，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">CHECKPOINT_PATH</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;mymodel/best_checkpoint.h5&#34;</span><span class="p">),</span><span class="c1">#change</span>
</span></span><span class="line"><span class="cl">        <span class="mi">2</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_2state_all.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">3</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_3state_all.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">5</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_5state_all.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;das&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;mymodel/best_checkpoint.h5&#34;</span><span class="p">),</span><span class="c1">#change</span>
</span></span><span class="line"><span class="cl">        <span class="mi">2</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_2state_das.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">3</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_3state_das.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">5</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_5state_das.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;multi&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_1state_multi.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">2</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_2state_multi.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">3</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_3state_multi.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">5</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_5state_multi.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Attention, sometimes <code>sec_struct_utils.py</code> will automatically remove something before we process it，so we just remove the code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Delete temporary files这三行注释掉</span>
</span></span><span class="line"><span class="cl">   <span class="c1"># if sequence is not None:</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#     os.remove(fasta_file_path)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>then,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="n">current_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fasta_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;temp_</span><span class="si">{</span><span class="n">current_datetime</span><span class="si">}</span><span class="s2">.fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fasta_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;temp&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;temp_</span><span class="si">{</span><span class="n">current_datetime</span><span class="si">}</span><span class="s2">.fasta&#34;</span><span class="p">)</span><span class="c1">#改这里路径后是这样，我一般不用wandb</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It works, I test it just as <code>epoch = 1</code> but the performance is bull shit.</p>
<div align=center><img src="11.png" width=600/></div>
<center><font size=2>OMG, such epoch1</font></center>
<p>Then we improve it to 50epochs, like the author&rsquo;s default, it performed well. However, in the trainer.py, the author train it <strong>without early stopping method.</strong> So I add it to the script.</p>
<div align=center><img src="12.png" width=600/></div>
<center><font size=2>epoch=50</font></center>
<div align=center><img src="16.png" width=600/></div>
<center><font size=2>test it well</font></center>
<p>Then I am thinking about multi-scale attention, from <strong>Atlas: Multi-Scale Attention Improves Long Context Image Modeling</strong>. So, I added 3 layers of attention, but not multi-scale.</p>
<h3 id="multi-layer-attention-or-multihead-attention">Multi-layer attention or multihead attention?
</h3><p>Test it on the 500 dataset, grnade is：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Length Range</th>
          <th>Statistic</th>
          <th>Perplexity</th>
          <th>Recovery</th>
          <th>Edit Distance</th>
          <th>SC Score</th>
          <th>Sample Count</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0-100</td>
          <td>Median</td>
          <td>1.4128</td>
          <td>0.56445</td>
          <td>17.5972</td>
          <td>0.62315</td>
          <td>234</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Median</td>
          <td>1.26885</td>
          <td>0.73585</td>
          <td>30.2634</td>
          <td>0.61495</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Median</td>
          <td>1.3132</td>
          <td>0.64605</td>
          <td>226.875</td>
          <td>0.42835</td>
          <td>138</td>
      </tr>
      <tr>
          <td>0-100</td>
          <td>Mean</td>
          <td>1.47854274</td>
          <td>0.569795726</td>
          <td>18.55480427</td>
          <td>0.634651282</td>
          <td>234</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Mean</td>
          <td>1.34514583</td>
          <td>0.685369444</td>
          <td>37.49759306</td>
          <td>0.569984722</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Mean</td>
          <td>1.41243696</td>
          <td>0.639286232</td>
          <td>211.1403986</td>
          <td>0.421031884</td>
          <td>138</td>
      </tr>
  </tbody>
</table></div>
<p>multiheadattention:</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Length Range</th>
          <th>Statistic</th>
          <th>Perplexity</th>
          <th>Recovery</th>
          <th>Edit Distance</th>
          <th>SC Score</th>
          <th>Sample Count</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0-100</td>
          <td>Median</td>
          <td>1.30675</td>
          <td>0.5532</td>
          <td>17.21875</td>
          <td>0.62105</td>
          <td>234</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Median</td>
          <td>1.17275</td>
          <td>0.7444</td>
          <td>29.75</td>
          <td>0.62205</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Median</td>
          <td>1.30785</td>
          <td>0.70485</td>
          <td>183.84375</td>
          <td>0.41915</td>
          <td>140</td>
      </tr>
      <tr>
          <td>0-100</td>
          <td>Mean</td>
          <td>1.36121325</td>
          <td>0.572758974</td>
          <td>18.34507564</td>
          <td>0.638930342</td>
          <td>234</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Mean</td>
          <td>1.24458056</td>
          <td>0.704726389</td>
          <td>35.62898472</td>
          <td>0.605529167</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Mean</td>
          <td>1.36845071</td>
          <td>0.685876429</td>
          <td>180.6455357</td>
          <td>0.430865714</td>
          <td>140</td>
      </tr>
  </tbody>
</table></div>
<p>Multi-layer attention：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Length Range</th>
          <th>Statistic</th>
          <th>Perplexity</th>
          <th>Recovery</th>
          <th>Edit Distance</th>
          <th>SC Score</th>
          <th>Sample Count</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0-100</td>
          <td>Median</td>
          <td>1.3358</td>
          <td>0.5592</td>
          <td>17.6667</td>
          <td>0.6396</td>
          <td>235</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Median</td>
          <td>1.2226</td>
          <td>0.71205</td>
          <td>33.78125</td>
          <td>0.6771</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Median</td>
          <td>1.32545</td>
          <td>0.68665</td>
          <td>193.0625</td>
          <td>0.42465</td>
          <td>140</td>
      </tr>
      <tr>
          <td>0-100</td>
          <td>Mean</td>
          <td>1.36930766</td>
          <td>0.557402979</td>
          <td>18.98926</td>
          <td>0.660275319</td>
          <td>235</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Mean</td>
          <td>1.28780417</td>
          <td>0.682672222</td>
          <td>37.93399306</td>
          <td>0.624776389</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Mean</td>
          <td>1.40186786</td>
          <td>0.673555</td>
          <td>187.8361607</td>
          <td>0.434380714</td>
          <td>140</td>
      </tr>
  </tbody>
</table></div>
<p>We then compare the SCC，Recovery.</p>
<div align=center><img src="18.png" width=600/></div>
<p>After that, we test grnade and multi-layer attention on 12000+data,</p>
<div align=center><img src="17.png" width=600/></div>
<center><font size=2>SCC improved</font></center>
<h3 id="data-leakage-issue-came-up">Data leakage issue came up
</h3><p>The author had over 13,000 samples (from RNAsolo 2023), with about 12,000 usable ones. Among them, the training split has 12,000+, the validation set has about 500+, and only around 200 are in the test set.</p>
<p>What’s that supposed to mean? 12,000 : 500 : 200 — that’s nowhere near the usual 8:1:1 split! And it gets even worse — those 200 test samples don’t even go beyond a length of 200. Like, what am I supposed to test with that?</p>
<div align=center><img src="picture.png" width=300/></div>
<center><font size=2>test set,0-160 length range</font></center>
<p>So we need to optimize this split method. My idea is to first split the clusters based on length ranges — 0–100, 100–200, and 200+. Then, within each range, I’ll select clusters using an 8:1:1 ratio. Finally, I’ll extract the PDB indices contained in each cluster. That way, it should make our experiments more balanced and meaningful.</p>
<div align=center><img src="output1.png" width=400/></div>
<center><font size=2>train split， range, 12000+data</font></center>
<div align=center><img src="output2.png" width=400/></div>
<center><font size=2>validation split, range,450data</font></center>
<div align=center><img src="output3.png" width=400/></div>
<center><font size=2>test split, almost 660 data</font></center>
<p>Meanwhile, RNASolo has 3000+ more data in 2025 than 2023. Maybe we can use this? But let&rsquo;s focus on our primary 2023 dataset to train and test equally.</p>
<div align=center><img src="rnasolo.png" width=400/></div>
<center><font size=2>2025 RNASolo</font></center>
<h2 id="optimization-methods-and-experiments">Optimization methods and experiments
</h2><p>After I evenly split the test set, I first retrained and tested the gRNAde model. The results were a bit unstable, but it wasn’t a big deal. Simple plot below:</p>
<div align=center><img src="grnanew.png" width=600/></div>
<center><font size=2>result in test split</font></center>
<p>After that, I trained gRNAde with 100 epochs and early stopping methods with <code>seed = 0, 1, 2</code> . Besides, I found that the <strong>previous attention approach</strong> helped capture <strong>long-range interactions</strong>, so I’m planning to optimize the <strong>GVP layer</strong> next.</p>
<h3 id="graph-mamba">Graph-Mamba
</h3><h4 id="mamba">Mamba
</h4><p>Different from RNN, the SSM(State Space Model) will &ldquo;remember&rdquo; the graph or text interactions better.</p>
<div align=center><img src="assets/image-20251024161030234.png" width=400/></div>
<center><font size=2>SSM model structure</font></center>
<div align=center><img src="assets/image-20251024161045596.png" width=400/></div>
<center><font size=2>SSM architecture details</font></center>
<p>For it promising performance,</p>
<div align=center><img src="assets/image-20251024161132071.png" width=400/></div>
<center><font size=2>SSM performance comparison</font></center>
<p>SSMs have rich theoretical properties but suffer from high computational cost and numerical instability. So HiPPO(High-order Polynomial Projection Operator) is proposed to optimize the SSM, as follows,</p>
<div align=center><img src="assets/image-20251024161322086.png" width=400/></div>
<center><font size=2>HiPPO framework</font></center>
<div align=center><img src="assets/image-20251024161343746.png" width=200/></div>
<center><font size=2>HiPPO optimization details</font></center>
<p>Notably, it is developed into the S4 model, which shows its strong capability to capture long-range dependencies.</p>
<div align=center><img src="assets/image-20251024161334191.png" width=400/></div>
<center><font size=2>S4 model capabilities</font></center>
<h4 id="graph-mamba-towards-long-range-graph-sequence-modeling-withselective-state-spaces">Graph-Mamba: Towards Long-Range Graph Sequence Modeling withSelective State Spaces
</h4><p>From the <strong>Graph-Mamba</strong>, we will know that,</p>
<ul>
<li>
<p>SSM：State Space Models, linear.</p>
</li>
<li>
<p>Based on GraphGPS.</p>
</li>
<li>
<p>Graph-Mamba-Block(GMB) replaced Attention.</p>
</li>
<li>
<p>MPNN (Message Passing Neural Network)—GatedGCN.</p>
</li>
<li>
<p>GraphGPS(MPNN)+GMB = Graph-Mamba.</p>
</li>
<li>
<p>Optimization: Node Prioritization; Permutation-based Training.</p>
</li>
</ul>
<div align=center><img src="assets/image-20251024153623567.png" width=400/></div>
<center><font size=2>Graph-Mamba architecture</font></center>
<p>In the same way, we just follow the algorithm and replace the <code>gvpcov</code> layer to our <code>graphgpsMamba</code>.</p>
<div align=center><img src="assets/image-20251024154038508.png" width=300/></div>
<center><font size=2>Algorithm implementation</font></center>
<div align=center><img src="assets/image-20251024154100968.png" width=300/></div>
<center><font size=2>GatedGCN and GraphGPS integration</font></center>
<p>The code will load GatedGCN as MPNN and combine it with graphGPS then add mamba block. However, graphGPS, or more specifically, gatedGCN, is not proposed to model our RNA molecules. So in our test, it performs worse than baseline.</p>
<div align=center><img src="assets/image-20251024153639628.png" width=400/></div>
<center><font size=2>Baseline comparison results</font></center>
<h3 id="long-short-transformer-and-graph-long-short-transformer">Long-Short Transformer and Graph Long-Short Transformer
</h3><p>We will learn from the article:</p>
<p><strong>Long-Short Transformer: Effcient Transformers for Language and Vision</strong></p>
<p>It shows a promising way to combine the different attention output. Actually, for the detail,</p>
<ul>
<li>
<p>Long-Short Transformer</p>
</li>
<li>
<p>Short-term attention via sliding window</p>
</li>
<li>
<p>Long-range attention via dynamic projection</p>
</li>
<li>
<p>Aggregating Long-range and Short-term Attentions&amp;DualLN</p>
</li>
</ul>
<div align=center><img src="assets/image-20251024162239002.png" width=400/></div>
<center><font size=2>Long-Short Transformer architecture</font></center>
<p>We then develop it into Long-short Graph Transformer, using <code>MultiGVPConv</code> for message passing, and sliding window for short attention, dynamic projection for long range. In the code, we mixed the edge features to node and processed the node scalar features, because the author&rsquo; s model from long-short transformer is 1D information for sentence modeling.</p>
<div align=center><img src="assets/image-20251024162251654.png" width=400/></div>
<center><font size=2>Long-short Graph Transformer implementation</font></center>
<div align=center><img src="assets/image-20251024162257996.png" width=400/></div>
<center><font size=2>Feature processing pipeline</font></center>
<p>Unluckily, although it outperformed than any others in 200+ nts long range rna modeling, the short and medium range would drop down.</p>
<h3 id="gat-gvp-long-short-graph-transformer">GAT-GVP long-short graph transformer
</h3><p>According to Graph Attention Networks, we changed the short range to the GAT to capture the neighbor interactions, maintain the 3D information.</p>
<div align=center><img src="assets/image-20251024162817129.png" width=400/></div>
<center><font size=2>GAT-GVP architecture</font></center>
<div align=center><img src="assets/image-20251024162828711.png" width=300/></div>
<center><font size=2>GAT neighbor interaction mechanism</font></center>
<h3 id="experiments">Experiments
</h3><h4 id="learning-rate">Learning rate
</h4><div align=center><img src="assets/image-20251024162348404.png" width=400/></div>
<center><font size=2>Learning rate comparison</font></center>
<p>We use our graph transformer which just adds a transformer into the layer, training with different lr, and finds out that when lr=0.0002, it will be the best.</p>
<h4 id="comparison">Comparison
</h4><p>We trained with seed0, and,</p>
<div align=center><img src="assets/image-20251024163430577.png" width=500/></div>
<center><font size=2>Training results with seed0</font></center>
<p>After that, we chose some of them to train 3 seeds as seed=0,1,2, then:</p>
<div align=center><img src="assets/image-20251024163553684.png" width=500/></div>
<center><font size=2>Multi-seed training comparison</font></center>
<h2 id="other-paper-reading">Other Paper Reading
</h2><p>Off-topic story — So last week I was totally slacking off when I suddenly saw an email from my advisor’s Zoom: “xxx invites you&hellip; at 11:30.” I thought maybe the meeting time had changed. But then I noticed the original 9:30 link was still active, not canceled.</p>
<p>So on the meeting day, the theory slides in my PPT still weren’t done, and I figured I’d hop into the 9:30 call just to check—<em>you know, just in case they actually started then.</em>
And sure enough, I heard: <em>“Alright, let’s get started.”</em></p>
<p>…And that’s how I GAME OVER&hellip;</p>
<p>This week I’m not doing anything fancy — just reading papers properly. Gotta figure out how to <em>tell a story</em> in the next report, right? Anyway, I’ll jot down a few things here that I think are somewhat insightful.</p>
<h3 id="a-hyperbolic-discrete-diffusion-3d-rna-inverse-folding-model-for-functional-rna-design">A Hyperbolic Discrete Diffusion 3D RNA Inverse Folding Model for functional RNA design。
</h3><h4 id="abstractintroduction">Abstract&amp;Introduction
</h4><ul>
<li><strong>Background:</strong> revolutionary opportunities for diverse RNA-based biotechnologies and biomedical applications.</li>
</ul>
<blockquote>
<p>primary goal of RNA inverse folding is to design nucleotide sequences that can fold into a given RNA secondary or tertiary structure.</p>
</blockquote>
<ul>
<li><strong>Challenge:</strong> limited availability of experimentally derived 3D structural data and unique characteristics of RNA 3D structures; existing tools either focus on 2D inverse folding tasks or learn limited 3D structural features from experimentally determined and predicted 3D structure datasets for the 3D inverse folding problem.</li>
<li><strong>High-resolution RNA structures</strong> are significantly <strong>less</strong> common compared to those of proteins.</li>
</ul>
<p><strong>RIdiffusion</strong>, a hyperbolic denoising diffusion generative RNA inverse folding model.</p>
<blockquote>
<p>RIdiffusion efficiently recovers the distribution of nucleotides for targeted RNA 3D structures based on limited training samples using a discrete diffusion model.</p>
</blockquote>
<p>Honestly, the background part is usually just the same old recycled stuff, but different papers tend to focus on different challenges. What really stood out to me in this one is how it combines geometric deep learning with a discrete diffusion model — plus, the evaluation is super thorough. You can tell they really put in the work on this one.</p>
<ul>
<li>structure based.</li>
<li>the promise of creating novel functional RNAs.</li>
</ul>
<p>The “low-sample” challenge underscores the importance of <strong>learning efficiency</strong> in generative models in 3D RNA inverse folding tasks.</p>
<p><strong>Diffusion</strong>: modeling inverse folding problem as diffusio n<strong>denoising</strong>.</p>
<p>RNA structures exhibit inherent hierarchical organization <strong>(e.g., from base-paring, secondary structure elements and remote pseudoknots to complex 3D shapes)</strong>——<strong>hyperbolic space.</strong></p>
<p>Why? Because:</p>
<blockquote>
<p>compared to Euclidean space, a hyperbolic distance better captures molecular differences and improve performance in small molecule generation tasks</p>
</blockquote>
<p>In other words, this HB metric captures structural features better than the Euclidean one — or you could say it reflects the more <em>subtle structural differences</em> more effectively. The authors illustrate this with the following figure:</p>
<img src="assets/image-20250923222419058-1761295098389-1.png" alt="image-20250923222419058" style="zoom: 33%; display: block; margin: 0px auto;" />
<p>We can mainly focus on panels A and D. Panel A shows a schematic of the transformation, while panel D visualizes how the RNA structures are distributed in the HB space. Simply put, different chains (or backbones) are separated more clearly there — which means the features can be captured more effectively.</p>
<h4 id="about-the-model">about the model
</h4><p><strong>hyperbolic equivariant graph neural networks</strong> (HEGNNs) to <strong>parameterize the discrete diffusion model</strong>, and effectively capture the 3D structural characteristics by <strong>incorporating RNA’s geometric features and topological properties</strong> into the generation process.</p>
<p>framework：</p>
<img src="assets/image-20250923230102547-1761295098390-4.png" alt="image-20250923230102547" style="zoom: 25%; display: block; margin: 0px auto;" />
<h4 id="materials-and-methods">MATERIALS AND METHODS
</h4><p>I would just understand the <strong>Hyperbolic Equivariant Graph Denoising Network</strong>, Normally, models tend to lose some information when dealing with this kind of 3D data.</p>
<p>So the author utilizes <strong>SE(3) equivariant neural layers</strong> from Equivariant Graph Neural Networks (EGNN).49 This approach allows the model to preserve SO(3) rotational equivariance and E(3) translational invariance when updating the representations of nodes and edges, thereby retaining geometric information and ensuring the robustness and effectiveness of the hidden representations, to enable the EGNN network to update edge.其实就是加了个层。</p>
<h4 id="datasets-and-setup">Datasets and Setup
</h4><p>So how the author split？</p>
<blockquote>
<p>We followed the same splitting methods outlined in RDesign to ensure a high-quality dataset with only experimentally derived structures, which consists of 1773 structures for training, 221 structures for validation, and 223 structures for testing in an 8:1:1 ratio.</p>
</blockquote>
<p>According <strong>8:1:1</strong>.</p>
<p>In addition, to evaluate the <strong>generalization ability</strong>, the authors used <strong>PSI-CD-HIT</strong> to cluster the data based on <strong>nucleotide similarity</strong>, setting similarity thresholds of 0.8, 0.9, and 1.0。</p>
<h4 id="evaluation-metrics">Evaluation Metrics
</h4><p>Besides Recovery Rate, there is Macro-F1 score,</p>
<blockquote>
<p>The Macro-F1 score is used to assess the accuracy and comprehensiveness of the model in predicting protein or RNA sequences, particularly in cases where the distribution of different letter residues is imbalanced, by evaluating the Macro-F1 score for each residue in the sequence.</p>
</blockquote>
$$
NoveltyScore(x_i) = 1.0 - RecoveryRate(x_i,x_{mostsimilar})
$$<p>There’s also a <strong>GSN (Global-scale Novelty)</strong> metric, where 100 samples are drawn using RR-based stratified sampling.</p>
<p>And there’s another one, quite similar to <strong>SCC</strong> — it’s based on structures folded with <strong>RhoFold</strong>, then structural similarity is computed using <strong>US-align</strong>, which gives the <strong>RMSD</strong> value.</p>
<h4 id="baselines">Baselines
</h4><p>1 RNA tertiary structure inverse folding model, 3 protein tertiary structure inverse folding baselines, 1 Transformer-based graph GNN network for graph structure: <strong>gRNAde, PiFold, StructGNN, GVP-GNN, and GraphTrans.</strong></p>
<p>Author of RiboDiffusion&amp;RhoDesign provided no training scripts in the released code.</p>
<h4 id="results">Results
</h4><blockquote>
<p>we divided the dataset of seq-0.8 into short (&lt;50nt), medium (50~100nt), and long (&gt;100nt)</p>
</blockquote>
<p>Emm&hellip; is that long???</p>
<blockquote>
<p>The novelty of generative designs can be viewed from two perspectives: <strong>sequence novelty and physicochemical properties novelty.</strong> In our case, sequence and physicochemical properties (derived from sequence) novelty are important in RNA 3D inverse folding. Indeed, sequence features such as physicochemical properties play a crucial role in functional RNA design. For instance, it was reported that natural RNAs show privileged physicochemical property space which is related to their biological functions. Other sequence features like GC content are important properties related to developability of RNA molecules. Given the nature of one-to-many relationship between the targeted RNA structure and its possible sequences, the novelty and diversity of generated sequences are important considerations for improving physicochemical properties of the designed sequences.</p>
</blockquote>
<p>physicochemical properties space, evaluation,</p>
<div align=center><img src="assets/image-20250923234501726-1761295098390-2.png" width=400/></div>
<center><font size=2>Physicochemical properties evaluation</font></center>
<h3 id="beyond-rna-structure-alone-complex-aware-feature-fusion-for-tertiary-structure-based-rna-design">Beyond RNA Structure Alone: Complex-Aware Feature Fusion for Tertiary Structure-based RNA Design
</h3><h4 id="abstract">Abstract
</h4><ul>
<li>important in synthetic biology and therapeutics</li>
<li>limitation: <strong>overlook the role of complex-level information</strong></li>
</ul>
<p>In fact, the authors argue that analyzing RNA alone isn’t enough — you also have to look at the related complexes.</p>
<blockquote>
<p>our method incorporates protein features extracted by protein language model (e.g., ESM-2)</p>
</blockquote>
<p>To address bio-logical complexity of protein-RNA interactions, propose a distance-aware filtering for local features from protein representation.</p>
<blockquote>
<p>a high-affinity design framework that combines our CARD with an affinity evaluation model.</p>
</blockquote>
<p>Final goal: produce high-affinity RNA sequences</p>
<h4 id="introduction">Introduction
</h4><ul>
<li>more sophisticated computational approaches that can model the complex relationship between RNA sequences and their structures.</li>
</ul>
<p>The authors also mentioned <strong>LEARNA</strong> and <strong>Meta-LEARNA</strong>, which are RL-based, as well as <strong>RDesign</strong> and <strong>RhoDesign</strong>, which are based on 3D graph representations.</p>
<ul>
<li>different from protein folding which roughly follows Anfinsen’s rule, RNAs are highly flexible and rely on interactions with proteins, DNA, and other biomolecules to achieve folding.</li>
<li>RNAs may adopt various conformations by interacting with distinct macromolecules at different stages of functioning. At different stages, they also bind with macromolecules.</li>
</ul>
<img src="assets/image-20250924001621731-1761295098390-3.png" alt="image-20250924001621731" style="zoom: 33%; display: block; margin: 0px auto;" />
<p>This paper considers both RNA structural features and protein–RNA interactions to generate sequences comprehensively.</p>
<p>The outline, as shown in Figure 1, includes a <strong>pre-trained protein language model (PLM)</strong> to handle proteins, and a <strong>Complex-Aware Transformer (CAFormer)</strong> to integrate RNA and protein features. They use <strong>distance-aware filtering</strong> to select relevant regions while ignoring unrelated areas. This setup allows the model to capture the context of protein–RNA complexes and focus on the interaction regions within the complex.</p>
<p>Overall, the authors iteratively screen the generated RNA sequences: candidate sequences are first filtered based on predicted affinity scores, and then structural compatibility is validated using multiple folding models.</p>
<p><strong>Affinity Evaluation</strong></p>
<p>Regarding <strong>“affinity”</strong>, the authors mention predictive models like <strong>PNAB, DeePNAP, PredPRBA, PRdeltaGPred, and PRA-Pred</strong>.</p>
<p>However, structural data for RNA–protein complexes is very limited. <strong>CoPRA</strong> integrates <strong>PRA310</strong> and introduces a <strong>multi-modal model</strong>, which combines RNA and protein language models with comprehensive structural information.</p>
<p>Additionally, the authors also discuss the development and background of <strong>inverse folding</strong>:</p>
<blockquote>
<p>RNA design aims to generate sequences that fold into <strong>predefined structures.</strong> Early methods focused on <strong>secondary structure optimization</strong>, using <strong>thermodynamic parameters</strong> and <strong>energy minimization</strong>. Tools like <strong>RNAfold</strong> predict RNA secondary structures based on the <strong>minimum free energy principle</strong>. As understanding of RNA structure has advanced, focus has shifted to <strong>complex tertiary structure-based design</strong> due to RNA’s high conformational flexibility, which challenges traditional thermodynamic methods. Recent deep learning approaches for RNA tertiary structure design include <strong>gRNAde, which utilizes geometric deep learning and graph neural networks to generate RNA sequences</strong>; <strong>RiboDiffusion</strong>, a diffusion model for inverse folding leveraging RNA backbone structures; <strong>RDesign</strong>, which employs a data-efficient learning framework with contrastive learning for tertiary structures; and <strong>Rhodesign</strong>, focusing on RNA aptamer design by guiding sequence generation through structural predictions.</p>
</blockquote>
<h4 id="methods">Methods
</h4><img src="assets/image-20250924003914813-1761295098390-6.png" alt="image-20250924003914813" style="zoom: 25%; display: block; margin: 0px auto;" />
<p>It’s actually quite comprehensive. Regarding that <strong>filter</strong>, since a single protein can bind RNA through multiple sites (different conformations), and a single RNA can also interact with different proteins, the authors provide the following figure to illustrate this:</p>
<img src="assets/image-20250924004136830-1761295098390-7.png" alt="image-20250924004136830" style="zoom: 33%; display: block; margin: 0px auto;" />
<p><strong>COMPLEX-AWARE ATTENTION BLOCK</strong></p>
<p>For this part, the authors first concatenate the RNA and the filtered protein information, and then use <strong>N multi-head self-attention layers</strong> to enhance the model’s ability to capture contextual interactions.</p>
<img src="assets/image-20250924004411039-1761295098390-5.png" alt="image-20250924004411039" style="zoom: 25%; display: block; margin: 0px auto;" />
<p>After that, they use a <strong>Transformer-based decoder</strong>, similar to RhoDesign, to generate RNA sequences. The decoding is framed as a <strong>next-token prediction task</strong>, where the decoder predicts the next nucleotide based on the previously generated ones. During training, the model is optimized using <strong>cross-entropy loss</strong>.</p>
<p><strong>High-Affinity RNA Design Framework</strong></p>
<ul>
<li>structure-to-sequence design model and evaluation tools.</li>
</ul>
<p>First, RNA sequences are designed using the authors’ model to meet <strong>complex-specific constraints</strong> (like binding sites and interactions). The sequences are then evaluated with <strong>ensemble regression models trained on the PRA201 dataset</strong>, while their structures are folded using <strong>AlphaFold3, RhoFold, and RoseTTAFold2NA</strong> to calculate RMSD. In each iteration, the top 10%–20% of sequences are selected, and the process is repeated until an optimal set is obtained.</p>
<h4 id="experiments-1">Experiments
</h4><p><strong>Dataset and Implementation Details</strong></p>
<ul>
<li>Datasets: PRI30K and PRA201.</li>
<li>The latter is used for the <strong>blind test</strong>, while the former removes structurally similar cases for <strong>training and testing</strong>. After processing, the dataset contains <strong>21,050 protein–RNA pairs</strong> and <strong>2,309 RNA sequences</strong>. Clustering is also done using <strong>CD-HIT</strong> with an <strong>80% similarity threshold</strong>.</li>
<li>200 epochs, batch size of 48 (24 per GPU), attention blocks <em>N</em> = 6, local filtered size <em>K</em> = 64, ESM-2 650M.</li>
<li>Comparison: SeqRNN and SeqLSTM, StructGNN, GraphTrans, RDesign, and RhoDesign.</li>
</ul>
<p><strong>Ablation Studies</strong></p>
<p>key components of  method, including the number of attention blocks in CAFormer, the fashion of filtering the protein representation, and the choices of protein representation model.</p>
<div align=center><img src="assets/image-20250924010453989-1761295098390-8.png" width=400/></div>
<center><font size=2>Ablation study results</font></center>
<h3 id="ribodiffusion-tertiary-structure-based-rna-inverse-folding-with-generative-diffusion-models">RiboDiffusion: tertiary structure-based RNA inverse folding with generative diffusion models
</h3><p><strong>Abstract:</strong></p>
<ul>
<li>
<p>scarcity of data, nonunique structure-sequence mapping, flexibility of RNA conformation.</p>
</li>
<li>
<p>growing applications in synthetic biology and therapeutics;</p>
</li>
<li>
<p>inverse folding problem;</p>
</li>
</ul>
<p><strong>Introduction:</strong></p>
<ul>
<li>
<p>RNA-based biotechnology;</p>
</li>
<li>
<p>early methods for focus on folding into RNA secondary structures; Some use efficient local search strategies guided by the energy function; Or globally by modeling the sequence distribution or directly manipulating diverse candidates;</p>
</li>
<li>
<p>DAS physically based approach, but still constrained by local design strategy and computational efficiency.</p>
</li>
</ul>
<p><strong>&ndash; only 2D, without considering 3D structures of RNA</strong></p>
<div align=center><img src="assets/image-20250924100631702-1761295098390-9.png" width=400/></div>
<center><font size=2>RiboDiffusion model overview</font></center>
<p><strong>Methods:</strong></p>
<p>Diffusion;</p>
<p>Three-atom coarse-grained representation including the atom coordinates of C4’, C1’, N1 (pyrimidine) or N9 (purine) for every nucleotide;</p>
<p>Consider the RNA inverse folding problem as modeling the conditional distribution p(S|X);</p>
<p>Based on the GVP-GNN architecture;</p>
<p><strong>Results</strong></p>
<p>Dataset: predicting structures with RhoFold. The structures predicted from RNAcentral sequences are filtered by pLDDT to keep only high-quality predictions, resulting in 17 000 structures.</p>
<p>Cluster: sequence&ndash;PSI-CD-HIT to cluster sequences based on nucleotide similarity. We set the threshold at 0:8=0:6=0:4 and obtain 1252=1157=1114 clusters; structure similarity clustering,  calculate the TM-score matrix using US-align and apply scipy, achieve 2036=1659=1302 clusters with TM-score thresholds of 0:6=0:5=0:4. 15% for testing, 10% for validation.</p>
<p><strong>Evaluation Metrics:</strong></p>
<p>RR, F1 Score(RNAfold and RMSD)</p>
<h3 id="learning-to-design-rna">Learning to Design RNA
</h3><p><strong>Abstract:</strong></p>
<ul>
<li>
<p>Based on <strong>deep reinforcement learning</strong>;</p>
</li>
<li>
<p>Jointly optimize over a rich space of architectures for the policy network, the hyperparameters of the training procedure and the formulation of the decision process.</p>
</li>
</ul>
<p><strong>Introduction:</strong></p>
<ul>
<li>
<p><strong>LEARNA:</strong> deep RL algorithm for RNA Design. Given a target secondary structure, can predict the entire RNA sequence. After generating an RNA sequence, then folds this and locally adapts it, and uses the distance of the resulting structure to the target structure as an error signal for the RL agent;</p>
</li>
<li>
<p><strong>Meta-LEARNA:</strong> learns a single policy across many RNA Design tasks directly applicable to new RNA Design tasks;</p>
</li>
<li>
<p>The first <strong>application of architecture search</strong> (AS) to RL;</p>
</li>
<li>
<p><strong>New benchmark dataset</strong> with an explicit training, validation and test split;</p>
</li>
<li>
<p><strong>Faster.</strong></p>
</li>
</ul>
<p><strong>THE RNA DESIGN PROBLEM:</strong></p>
<ul>
<li>
<p>Folding algorithm: zuker;</p>
</li>
<li>
<p>Loss Function: Hamming diastance.</p>
</li>
</ul>
<p><strong>LEARNING TO DESIGN RNA:</strong></p>
<p><strong>Action Space, State Space, Transition Function, Reward Function</strong>;</p>
<ul>
<li>
<p>One problem of current deep reinforcement learning methods is that their performance can be very sensitive to choices regarding the architecture of the policy network, the training hyperparameters, and the formulation of the problem as a decision process.</p>
</li>
<li>
<p>RL often yield noisy or unreliable outcomes in single optimization runs, (a) The number of unsolved sequences, (b) the sum of mean distances, <strong>(c) the sum of minimum distances to the target structure.</strong></p>
</li>
</ul>
<div align=center><img src="assets/image-20250924101020080-1761295098390-10.png" width=400/></div>
<center><font size=2>RL optimization metrics</font></center>
<h3 id="rna-dcgen-dual-constrained-rna-sequence-generation-with-llm-attack"><strong>RNA-DCGen: Dual Constrained RNA Sequence</strong> Generation with LLM-Attack
</h3><ul>
<li>
<p><strong>Challenge:</strong> recent diffusion and flowmatching-based models face two key limitations: specialization for fixed constraint types, such as tertiary structures, and lack of flexibility in imposing additional conditions beyond the primary property of interest.</p>
</li>
<li>
<p>Generative &ndash;&gt; Search;</p>
</li>
<li>
<p>Dual Constrained: on the sequence itself and on specified constraints.</p>
</li>
</ul>
<div align=center><img src="assets/image-20250924101257338-1761295098390-12.png" width=400/></div>
<center><font size=2>RNA-DCGen framework</font></center>

</section>


    <footer class="article-footer">
    

    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 Xiangyu Wen
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<style>
  body {
    background: url(https://mosfish.github.io/background/bac.webp) no-repeat center top;
    background-size: cover;
    background-attachment: fixed;
  }
   @font-face {
    font-family: 'note';
    src: url(https://mosfish.github.io/font/suc.ttf) format('truetype');
  }

  :root {
    --base-font-family: 'note';
    --code-font-family: 'note';
  }
</style>
<style>
    .highlight {
         
        max-height: 400px;
        overflow: hidden;
    }

    .code-show {
        max-height: none !important;
    }

    .code-more-box {
        width: 100%;
        padding-top: 78px;
        background-image: -webkit-gradient(linear, left top, left bottom, from(rgba(255, 255, 255, 0)), to(#fff));
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    .code-more-btn {
        display: block;
        margin: auto;
        width: 44px;
        height: 22px;
        background: #f0f0f5;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        padding-top: 6px;
        cursor: pointer;
    }

    .code-more-img {
        cursor: pointer !important;
        display: block;
        margin: auto;
        width: 22px;
        height: 16px;
    }
</style>

<script>
  function initCodeMoreBox() {
    let codeBlocks = document.querySelectorAll(".highlight");
    if (!codeBlocks) {
      return;
    }
    codeBlocks.forEach(codeBlock => {
      
      if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
        return;
      }
      
      
      let codeMoreBox = document.createElement('div');
      codeMoreBox.classList.add('code-more-box');
      
      let codeMoreBtn = document.createElement('span');
      codeMoreBtn.classList.add('code-more-btn');
      codeMoreBtn.addEventListener('click', () => {
        codeBlock.classList.add('code-show');
        codeMoreBox.style.display = 'none';
        
        window.dispatchEvent(new Event('resize'))
      })
      
      let img = document.createElement('img');
      img.classList.add('code-more-img');
      img.src = "https://mosfish.github.io/icons/codeMore.png"
      
      codeMoreBtn.appendChild(img);
      codeMoreBox.appendChild(codeMoreBtn);
      codeBlock.appendChild(codeMoreBox)
    })
  }
  
  initCodeMoreBox();
</script>



    </body>
</html>
