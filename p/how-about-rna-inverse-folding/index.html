<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Learning to design RNA(Experiments)">
<title>How about RNA inverse folding?</title>

<link rel='canonical' href='https://mosfish.github.io/p/how-about-rna-inverse-folding/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="How about RNA inverse folding?">
<meta property='og:description' content="Learning to design RNA(Experiments)">
<meta property='og:url' content='https://mosfish.github.io/p/how-about-rna-inverse-folding/'>
<meta property='og:site_name' content='Mosfish&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-09-04T15:36:23&#43;08:00'/><meta property='article:modified_time' content='2025-09-04T15:36:23&#43;08:00'/>
<meta name="twitter:title" content="How about RNA inverse folding?">
<meta name="twitter:description" content="Learning to design RNA(Experiments)">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/head_hu_c416b63add1b23cc.webp" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Mosfish&#39;s Blog</a></h1>
            <h2 class="site-description">I still feel like it has something to do with those fries on the pier.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='mailto:wenxy59@mail2.sysu.edu.cn'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" /><path d="M3 7l9 6l9 -6" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/Mosfish'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://mosfish.github.io/'
                        target="_blank"
                        title="Homepage"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-building-bank"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 21l18 0" /><path d="M3 10l18 0" /><path d="M5 6l7 -3l7 3" /><path d="M4 10l0 11" /><path d="M20 10l0 11" /><path d="M8 14l0 3" /><path d="M12 14l0 3" /><path d="M16 14l0 3" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.linkedin.com/in/xiangyuwen-mosfish/'
                        target="_blank"
                        title="Linkedin"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 11v5" /><path d="M8 8v.01" /><path d="M12 16v-5" /><path d="M16 16v-3a2 2 0 1 0 -4 0" /><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z" /></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页 | Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E-about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于| About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档 | Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索 | Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E6%8A%80%E6%9C%AF%E9%93%BE%E6%8E%A5friends-links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>技术链接&amp;friends | Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#服务器需要的一些设置">服务器需要的一些设置</a></li>
    <li><a href="#训练模型的注意事项">训练模型的注意事项</a>
      <ol>
        <li><a href="#数据预处理">数据预处理</a></li>
      </ol>
    </li>
    <li><a href="#模型使用与实验">模型使用与实验</a>
      <ol>
        <li><a href="#另一个生成范式ribodiffusion">另一个生成范式：RiboDiffusion</a></li>
        <li><a href="#初步改进attention">初步改进——attention</a></li>
        <li><a href="#第一次测试训练的模型">第一次测试训练的模型</a></li>
        <li><a href="#测试multi-scale在数据集的效果">测试Multi-scale在数据集的效果</a>
          <ol>
            <li><a href="#但是数据泄露的问题来了">但是数据泄露的问题来了</a></li>
          </ol>
        </li>
        <li><a href="#痛定思痛如何优化split方法">痛定思痛：如何优化split方法？</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/ai4s/" style="background-color: #800020; color: #fff;">
                AI4S
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/how-about-rna-inverse-folding/">How about RNA inverse folding?</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Learning to design RNA(Experiments)
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 04, 2025</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="如何优化rna逆合成模型">如何优化rna逆合成模型
</h1><p>这是一个很challenging的问题，别问，问就是啥都不会。</p>
<p>考虑到gRNAde: Geometric Deep Learning for 3D RNA Inverse Design论文的细节、思路非常清晰，且作者release了非常具象的source code，因而以gRNAde等state-of-the-art模型入手分析问题，作者代码开源地址：https://github.com/chaitjo/geometric-rna-design</p>
<h2 id="服务器需要的一些设置">服务器需要的一些设置
</h2><p>在这个过程中，注意一些tricks。由于租用的国内服务器与英国的环境不太一样，因此需要多使用数据盘而非系统盘。本项目最大的问题是作者的环境变量设置。</p>
<blockquote>
<p>Python 3.10.12 and CUDA 11.8, numpy &lt;2.0</p></blockquote>
<ul>
<li>镜像网站加速</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">git clone https://ghfast.top/github.com/chaitjo/geometric-rna-design
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cd /root/autodl-tmp/geometric-rna-design
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>此外，在数据盘配环境</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mamba create -p /root/autodl-tmp/rna python=3.10
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果需要激活环境，请注意相对路径：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mamba activate /root/autodl-tmp/rna
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>配置租用服务器版本环境变量，下方命令只对当前shell有效。建议写入bashrc或者利用作者给出的.env文件，记得<code>source ~/.bashrc</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PROJECT_PATH</span><span class="o">=</span><span class="s1">&#39;/root/autodl-tmp/geometric-rna-design/&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">ETERNAFOLD</span><span class="o">=</span><span class="s1">&#39;/root/autodl-tmp/geometric-rna-design/tools/EternaFold&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">X3DNA</span><span class="o">=</span><span class="s1">&#39;/root/autodl-tmp/geometric-rna-design/tools/x3dna-v2.4&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&#34;/root/autodl-tmp/geometric-rna-design/tools/x3dna-v2.4/bin:$PATH&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&#34;/root/autodl-tmp/cdhit:$PATH&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PYTORCH_CUDA_ALLOC_CONF</span><span class="o">=</span><span class="n">max_split_size_mb</span><span class="p">:</span><span class="mi">128</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>而相应的，英国项目版本则按照如下，放到<code>.env</code>文件里。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PROJECT_PATH</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">DATA_PATH</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/data/&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">WANDB_PROJECT</span><span class="o">=</span><span class="s1">&#39;rna&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">WANDB_ENTITY</span><span class="o">=</span><span class="s1">&#39;wenxy59-sun-yat-sen-university&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">WANDB_DIR</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">ETERNAFOLD</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/tools/EternaFold&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">X3DNA</span><span class="o">=</span><span class="s1">&#39;/home/remote1/geometric-rna-design/tools/x3dna-v2.4&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&#34;/home/remote1/geometric-rna-design/tools/x3dna-v2.4/bin:$PATH&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PYTORCH_CUDA_ALLOC_CONF</span><span class="o">=</span><span class="n">max_split_size_mb</span><span class="p">:</span><span class="mi">128</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="训练模型的注意事项">训练模型的注意事项
</h2><h3 id="数据预处理">数据预处理
</h3><p>注意运行main脚本前，需要处理数据生成process.pt文件，并生成相应的das_split.pt文件。在这个过程中，需要安装USalign与qTMclust工具。一般而言，安装后者的同时会自动安装前者。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">git clone https://github.com/pylelab/USalign.git
</span></span><span class="line"><span class="cl">cd USalign
</span></span><span class="line"><span class="cl">g++ -O3 -o qTMclust qTMclust.cpp -lm
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后就可以使用<code>USalign -h</code>与<code>qTMclust -h</code>命令来验证安装，记得查一下路径。在训练脚本里的相应位置路径用的相对路径可能报错，例如<code>src/data/clustering_units.py</code>记得修改。</p>
<div align=center><img src="1.png" width=400/></div>
<center><font size=2>处理数据成功</font></center>
<p>数据处理大概是把14000+条raw数据处理为3910条可用数据，因为raw数据有残缺的处理后筛查出去了，因而数据不多，正常。</p>
<div align=center><img src="2.png" width=400/></div>
<center><font size=2>有问题的数据</font></center>
<p>然后用notebook里的代码生成split文件。</p>
<h2 id="模型使用与实验">模型使用与实验
</h2><p>作者给出.py脚本进行启动，或者用命令行如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">python gRNAde.py     --pdb_filepath data/raw/6J6G_1_L-E.pdb     --output_filepath tutorial/lnc/po/114.fasta     --split das     --max_num_conformers 1  --n_samples 16     --temperature 0.5
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用效果如图：</p>
<div align=center><img src="3.png" width=400/></div>
<center><font size=2>利用gRNAde预测结构与序列</font></center>
<p>模型在长rna序列（100+nts）的时候性能会下降，虽然recovery保持良好但是二级结构自洽性得分SC Score呈现明显线性下降。</p>
<div align=center><img src="6.png" width=600/></div>
<center><font size=2>四个参数直观对比</font></center>
<div align=center><img src="4.png" width=300/><img src="5.png" width=300/></div>
<center><font size=2>SC Score(左)与Recovery(右)随Sequence的变化</font></center>
<h3 id="另一个生成范式ribodiffusion">另一个生成范式：RiboDiffusion
</h3><p>至于RiboDiffusion，其他部署方式一致但是环境设置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">rna2</span> <span class="n">python</span><span class="o">=</span><span class="mf">3.10</span> <span class="o">-</span><span class="n">y</span>
</span></span><span class="line"><span class="cl"><span class="n">conda</span> <span class="n">activate</span> <span class="n">rna2</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">==</span><span class="mf">1.13</span><span class="o">.</span><span class="mi">1</span><span class="o">+</span><span class="n">cu116</span> <span class="n">torchvision</span><span class="o">==</span><span class="mf">0.14</span><span class="o">.</span><span class="mi">1</span><span class="o">+</span><span class="n">cu116</span> <span class="n">torchaudio</span><span class="o">==</span><span class="mf">0.13</span><span class="o">.</span><span class="mi">1</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="n">url</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">whl</span><span class="o">/</span><span class="n">cu116</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">absl</span><span class="o">-</span><span class="n">py</span><span class="o">==</span><span class="mf">0.15</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">biopython</span><span class="o">==</span><span class="mf">1.80</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">dm_tree</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">7</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">fair</span><span class="o">-</span><span class="n">esm</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">ml_collections</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">numpy</span><span class="o">==</span><span class="mf">1.24</span><span class="o">.</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">scipy</span><span class="o">&gt;=</span><span class="mf">1.10</span><span class="o">.</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">tqdm</span><span class="o">==</span><span class="mf">4.64</span><span class="o">.</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">-</span><span class="n">cluster</span><span class="o">==</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">1</span><span class="o">+</span><span class="n">pt113cu116</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">pyg</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">whl</span><span class="o">/</span><span class="n">torch</span><span class="o">-</span><span class="mf">1.13</span><span class="o">.</span><span class="mi">0</span><span class="o">+</span><span class="n">cu116</span><span class="o">.</span><span class="n">html</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">-</span><span class="n">scatter</span><span class="o">==</span><span class="mf">2.1</span><span class="o">.</span><span class="mi">1</span><span class="o">+</span><span class="n">pt113cu116</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">data</span><span class="o">.</span><span class="n">pyg</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">whl</span><span class="o">/</span><span class="n">torch</span><span class="o">-</span><span class="mf">1.13</span><span class="o">.</span><span class="mi">0</span><span class="o">+</span><span class="n">cu116</span><span class="o">.</span><span class="n">html</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">torch</span><span class="o">-</span><span class="n">geometric</span><span class="o">==</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据脚本运行，输出会出现一些问题，例如：</p>
<div align=center><img src="7.png" width=400/></div>
<center><font size=2>RiboDiffusion输出</font></center>
<div align=center><img src="8.png" width=400/></div>
<div align=center><img src="9.png" width=400/></div>
<center><font size=2>RiboDiffusion模型的Recovery在对数坐标(上)与常数坐标(下)表示下随Sequence的变化</font></center>
<p>原始的启动脚本为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">diffusion</span> <span class="kn">import</span> <span class="n">NoiseScheduleVP</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sampling</span> <span class="kn">import</span> <span class="n">get_sampling_fn</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">du</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">functools</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tree</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">configs.inference_ribodiffusion</span> <span class="kn">import</span> <span class="n">get_config</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Choose heckpoint name</span>
</span></span><span class="line"><span class="cl"><span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s1">&#39;./ckpts/exp_inf.pth&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># checkpoint_path = &#39;./ckpts/exp_inf_large.pth&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="c1"># config.eval.sampling_steps = 100</span>
</span></span><span class="line"><span class="cl"><span class="n">NUM_TO_LETTER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_optimizer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;&#34;&#34;Return a flax optimizer object based on `config`.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;Adam&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">beta1</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;AdamW&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">amsgrad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Optimizer </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span><span class="si">}</span><span class="s1"> not supported yet!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">optimizer</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize model</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ema</span> <span class="o">=</span> <span class="n">ExponentialMovingAverage</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ema_decay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">optimizer</span> <span class="o">=</span> <span class="n">get_optimizer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">ema</span><span class="o">=</span><span class="n">ema</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">model_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model size: </span><span class="si">{:.1f}</span><span class="s1">MB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Load checkpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">state</span> <span class="o">=</span> <span class="n">restore_checkpoint</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ema</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize noise scheduler</span>
</span></span><span class="line"><span class="cl"><span class="n">noise_scheduler</span> <span class="o">=</span> <span class="n">NoiseScheduleVP</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">schedule</span><span class="p">,</span> <span class="n">continuous_beta_0</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">continuous_beta_0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">continuous_beta_1</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">continuous_beta_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Obtain data scalar and inverse scalar</span>
</span></span><span class="line"><span class="cl"><span class="n">inverse_scaler</span> <span class="o">=</span> <span class="n">get_data_inverse_scaler</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup sampling function</span>
</span></span><span class="line"><span class="cl"><span class="n">test_sampling_fn</span> <span class="o">=</span> <span class="n">get_sampling_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">noise_scheduler</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span><span class="p">,</span> <span class="n">inverse_scaler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb2data</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">du</span><span class="o">.</span><span class="n">PDBtoData</span><span class="p">,</span> <span class="n">num_posenc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_posenc</span><span class="p">,</span> <span class="n">num_rbf</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_rbf</span><span class="p">,</span> <span class="n">knn_num</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">knn_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Run inference on a single p</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb_file</span><span class="o">=</span> <span class="s1">&#39;/home/remote1/geometric-rna-design/data/raw/1FIR_1_A.pdb&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb_id</span> <span class="o">=</span> <span class="n">pdb_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.pdb&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">pdb_id</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdb_id</span> <span class="o">=</span> <span class="n">pdb_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">dynamic_threshold</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">cond_scale</span><span class="o">=</span><span class="mf">0.4</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">16</span>
</span></span><span class="line"><span class="cl"><span class="n">test_sampling_fn</span> <span class="o">=</span> <span class="n">get_sampling_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">noise_scheduler</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span><span class="p">,</span> <span class="n">inverse_scaler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">struct_data</span> <span class="o">=</span> <span class="n">pdb2data</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">struct_data</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map_structure</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">struct_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">samples</span> <span class="o">=</span> <span class="n">test_sampling_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">struct_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PDB ID: </span><span class="si">{</span><span class="n">pdb_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">native_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">NUM_TO_LETTER</span><span class="p">[</span><span class="n">struct_data</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Native sequence: </span><span class="si">{</span><span class="n">native_seq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># native_seq = &#39;&#39;.join(list(NUM_TO_LETTER[struct_data[&#39;seq&#39;].squeeze(0).cpu().numpy()]))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(f&#39;Native sequence: {native_seq}&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">designed_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">NUM_TO_LETTER</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]))</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated sequence </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">designed_seq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">recovery_</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">struct_data</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Recovery rate </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">recovery_</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>自动化设计为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">import</span> <span class="n">torch</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">tqdm</span> <span class="n">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">numpy</span> <span class="n">as</span> <span class="n">np</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">random</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">os</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">sys</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">datetime</span> <span class="n">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add the gRNAde path to import evaluation tools</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/remote1/geometric-rna-design/src&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/remote1/geometric-rna-design/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">models</span> <span class="n">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">utils</span> <span class="n">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">diffusion</span> <span class="n">import</span> <span class="n">NoiseScheduleVP</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">sampling</span> <span class="n">import</span> <span class="n">get_sampling_fn</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">datasets</span> <span class="n">import</span> <span class="n">utils</span> <span class="n">as</span> <span class="n">du</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">functools</span>
</span></span><span class="line"><span class="cl"><span class="n">import</span> <span class="n">tree</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">configs</span><span class="o">.</span><span class="n">inference_ribodiffusion</span> <span class="n">import</span> <span class="n">get_config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Import gRNAde evaluation functions</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">src</span><span class="o">.</span><span class="n">evaluator</span> <span class="n">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">self_consistency_score_eternafold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit_distance</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_utils</span> <span class="n">import</span> <span class="n">pdb_to_tensor</span><span class="p">,</span> <span class="n">get_c4p_coords</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">src</span><span class="o">.</span><span class="n">constants</span> <span class="n">import</span> <span class="n">NUM_TO_LETTER</span><span class="p">,</span> <span class="n">PROJECT_PATH</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Import BioPython for sequence handling</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">Bio</span> <span class="n">import</span> <span class="n">SeqIO</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">Bio</span><span class="o">.</span><span class="n">Seq</span> <span class="n">import</span> <span class="n">Seq</span>
</span></span><span class="line"><span class="cl"><span class="n">from</span> <span class="n">Bio</span><span class="o">.</span><span class="n">SeqRecord</span> <span class="n">import</span> <span class="n">SeqRecord</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Choose checkpoint name</span>
</span></span><span class="line"><span class="cl"><span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s1">&#39;./ckpts/exp_inf.pth&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_optimizer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Return a flax optimizer object based on `config`.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;Adam&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">beta1</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                              <span class="n">eps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;AdamW&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">amsgrad</span><span class="o">=</span><span class="n">True</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Optimizer {config.optim.optimizer} not supported yet!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">optimizer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_sec_struct_from_pdb</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Extract secondary structure from PDB file using gRNAde&#39;s data utilities.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequence</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">sec_struct</span><span class="p">,</span> <span class="n">sasa</span> <span class="o">=</span> <span class="n">pdb_to_tensor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">pdb_file</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">return_sec_struct</span><span class="o">=</span><span class="n">True</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">return_sasa</span><span class="o">=</span><span class="n">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">keep_insertions</span><span class="o">=</span><span class="n">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">sec_struct</span><span class="p">]</span> <span class="k">if</span> <span class="n">sec_struct</span> <span class="k">else</span> <span class="n">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">except</span> <span class="n">Exception</span> <span class="n">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Warning: Could not extract secondary structure from {pdb_file}: {e}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">prepare_raw_data_for_grnade_eval</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">,</span> <span class="n">native_seq</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Prepare raw data structure compatible with gRNAde evaluator.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequence</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">sec_struct</span><span class="p">,</span> <span class="n">sasa</span> <span class="o">=</span> <span class="n">pdb_to_tensor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">pdb_file</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">return_sec_struct</span><span class="o">=</span><span class="n">True</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">return_sasa</span><span class="o">=</span><span class="n">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">keep_insertions</span><span class="o">=</span><span class="n">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">raw_data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">native_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;coords_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">coords</span><span class="p">]</span> <span class="k">if</span> <span class="n">coords</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">None</span> <span class="k">else</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sec_struct_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">sec_struct</span><span class="p">]</span> <span class="k">if</span> <span class="n">sec_struct</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&#34;.&#34;</span><span class="p">]</span> <span class="o">*</span> <span class="n">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sasa_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">sasa</span><span class="p">]</span> <span class="k">if</span> <span class="n">sasa</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">raw_data</span>
</span></span><span class="line"><span class="cl">    <span class="n">except</span> <span class="n">Exception</span> <span class="n">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Warning: Could not prepare raw data from {pdb_file}: {e}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Return minimal raw data structure</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">native_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;coords_list&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sec_struct_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;.&#34;</span><span class="p">]</span> <span class="o">*</span> <span class="n">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sasa_list&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">evaluate_ribodiffusion_with_grnade_sc</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">native_seq</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">,</span> <span class="n">pdb_id</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                         <span class="n">output_dir</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">save_results</span><span class="o">=</span><span class="n">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Evaluate RiboDiffusion samples using gRNAde&#39;s self-consistency evaluation.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Prepare raw data for gRNAde evaluator</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">prepare_raw_data_for_grnade_eval</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">,</span> <span class="n">native_seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert RiboDiffusion samples to numpy arrays</span>
</span></span><span class="line"><span class="cl">    <span class="n">sample_arrays</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">sample_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sample_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create mask for coordinates (assume all positions are valid for now)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">native_seq</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="ne">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate basic metrics</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;pdb_id&#39;</span><span class="p">:</span> <span class="n">pdb_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;native_seq&#39;</span><span class="p">:</span> <span class="n">native_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;samples&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;recovery_rates&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;edit_distances&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert native sequence to numerical for recovery calculation</span>
</span></span><span class="line"><span class="cl">    <span class="n">letter_to_num</span> <span class="o">=</span> <span class="p">{</span><span class="n">letter</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">NUM_TO_LETTER</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">    <span class="n">native_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">letter_to_num</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">native_seq</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Evaluating {len(samples)} samples for {pdb_id}:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample_array</span> <span class="ow">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">sample_arrays</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">designed_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">NUM_TO_LETTER</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">sample_array</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">designed_seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculate recovery rate</span>
</span></span><span class="line"><span class="cl">        <span class="n">recovery</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_array</span> <span class="o">==</span> <span class="n">native_array</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;recovery_rates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculate edit distance using gRNAde&#39;s function</span>
</span></span><span class="line"><span class="cl">        <span class="n">edit_dist</span> <span class="o">=</span> <span class="n">edit_distance</span><span class="p">(</span><span class="n">designed_seq</span><span class="p">,</span> <span class="n">native_seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;edit_distances&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edit_dist</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Sample {i+1}: Recovery={recovery:.4f}, Edit_dist={edit_dist}&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Calculate self-consistency scores using gRNAde&#39;s EternaFold evaluator</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Calculating self-consistency scores with EternaFold...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sc_scores</span> <span class="o">=</span> <span class="n">self_consistency_score_eternafold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">sample_arrays</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;sec_struct_list&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">mask_coords</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc_scores</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sc_score</span> <span class="ow">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">sc_scores</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Sample {i+1}: SC_score={sc_score:.4f}&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="n">except</span> <span class="n">Exception</span> <span class="n">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Warning: Could not calculate SC scores: {e}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;This might be due to EternaFold not being properly installed or configured.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Save results</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">save_results</span> <span class="ow">and</span> <span class="n">output_dir</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Save as FASTA file compatible with gRNAde format</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequences</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># First record: input sequence with metadata</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SeqRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Seq</span><span class="p">(</span><span class="n">native_seq</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">            <span class="n">id</span><span class="o">=</span><span class="s2">&#34;input_sequence,&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">description</span><span class="o">=</span><span class="n">f</span><span class="s2">&#34;pdb_id={pdb_id}, ribodiffusion_evaluation&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Remaining records: designed sequences with metrics</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">recovery</span><span class="p">,</span> <span class="n">edit_dist</span><span class="p">,</span> <span class="n">sc_score</span><span class="p">)</span> <span class="ow">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;recovery_rates&#39;</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;edit_distances&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SeqRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">Seq</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                <span class="n">id</span><span class="o">=</span><span class="n">f</span><span class="s2">&#34;sample={i},&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="o">=</span><span class="n">f</span><span class="s2">&#34;recovery={recovery:.4f}, edit_dist={edit_dist}, sc_score={sc_score:.4f}&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Save FASTA</span>
</span></span><span class="line"><span class="cl">        <span class="n">fasta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">f</span><span class="s2">&#34;{pdb_id}_ribodiffusion_designs.fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SeqIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">fasta_path</span><span class="p">,</span> <span class="s2">&#34;fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Results saved to: {fasta_path}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Print summary statistics</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">{&#39;=&#39;*50}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Summary for {pdb_id}:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Native sequence length: {len(native_seq)}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Number of samples: {len(samples)}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Mean Recovery: {np.mean(results[&#39;recovery_rates&#39;]):.4f} ± {np.std(results[&#39;recovery_rates&#39;]):.4f}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Mean Edit Distance: {np.mean(results[&#39;edit_distances&#39;]):.2f} ± {np.std(results[&#39;edit_distances&#39;]):.2f}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sc_scores_eternafold&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;Mean SC Score (EternaFold): {np.mean(results[&#39;sc_scores_eternafold&#39;]):.4f} ± {np.std(results[&#39;sc_scores_eternafold&#39;]):.4f}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;SC Scores not calculated (EternaFold unavailable)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;{&#39;=&#39;*50}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize model</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ema</span> <span class="o">=</span> <span class="n">ExponentialMovingAverage</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ema_decay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">optimizer</span> <span class="o">=</span> <span class="n">get_optimizer</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">state</span> <span class="o">=</span> <span class="n">dict</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">ema</span><span class="o">=</span><span class="n">ema</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">model_size</span> <span class="o">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model size: {:.1f}MB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Load checkpoint</span>
</span></span><span class="line"><span class="cl"><span class="n">state</span> <span class="o">=</span> <span class="n">restore_checkpoint</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ema</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize noise scheduler</span>
</span></span><span class="line"><span class="cl"><span class="n">noise_scheduler</span> <span class="o">=</span> <span class="n">NoiseScheduleVP</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">schedule</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                 <span class="n">continuous_beta_0</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">continuous_beta_0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">continuous_beta_1</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">sde</span><span class="o">.</span><span class="n">continuous_beta_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Obtain data scalar and inverse scalar</span>
</span></span><span class="line"><span class="cl"><span class="n">inverse_scaler</span> <span class="o">=</span> <span class="n">get_data_inverse_scaler</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Setup sampling function</span>
</span></span><span class="line"><span class="cl"><span class="n">test_sampling_fn</span> <span class="o">=</span> <span class="n">get_sampling_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">noise_scheduler</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span><span class="p">,</span> <span class="n">inverse_scaler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb2data</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">du</span><span class="o">.</span><span class="n">PDBtoData</span><span class="p">,</span> <span class="n">num_posenc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_posenc</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">num_rbf</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_rbf</span><span class="p">,</span> <span class="n">knn_num</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">knn_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run inference</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb_file</span> <span class="o">=</span> <span class="s1">&#39;/home/remote1/geometric-rna-design/data/raw/7PIC_1_5.pdb&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">pdb_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.pdb&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Configure sampling</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">dynamic_threshold</span> <span class="o">=</span> <span class="n">True</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">cond_scale</span> <span class="o">=</span> <span class="mf">0.4</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Generate samples</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Processing PDB: {pdb_file}&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">test_sampling_fn</span> <span class="o">=</span> <span class="n">get_sampling_fn</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">noise_scheduler</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">sampling_steps</span><span class="p">,</span> <span class="n">inverse_scaler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">struct_data</span> <span class="o">=</span> <span class="n">pdb2data</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">struct_data</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">map_structure</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">    <span class="n">struct_data</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">samples</span> <span class="o">=</span> <span class="n">test_sampling_fn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">struct_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get native sequence</span>
</span></span><span class="line"><span class="cl"><span class="n">native_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">NUM_TO_LETTER</span><span class="p">[</span><span class="n">struct_data</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Native sequence: {native_seq}&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create output directory</span>
</span></span><span class="line"><span class="cl"><span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">output_dir</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&#34;ribodiffusion_grnade_eval_{current_time}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Evaluate with gRNAde&#39;s self-consistency framework</span>
</span></span><span class="line"><span class="cl"><span class="n">results</span> <span class="o">=</span> <span class="n">evaluate_ribodiffusion_with_grnade_sc</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">native_seq</span><span class="o">=</span><span class="n">native_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdb_file</span><span class="o">=</span><span class="n">pdb_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdb_id</span><span class="o">=</span><span class="n">pdb_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">save_results</span><span class="o">=</span><span class="n">True</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在13000条数据进行测试，</p>
<div align=center><img src="21.png" width=400/></div>
<center><font size=2>自动化测试</font></center>
<div align=center><img src="19.png" width=400/><img src="20.png" width=400/></div>
<center><font size=2>测试结果与测试结果（log后）</font></center>
<h3 id="初步改进attention">初步改进——attention
</h3><p>考虑到多层注意力机制会有利于长序列的捕捉，我先使用<code>MultiheadAttention</code>，加了一层简单的代码，进行训练。其中原本release的代码有bug，尤其是这个函数里的mask_coords掩码逻辑有问题，经常与sample的维度不匹配报错。我把修改过的<code>evaluator.py</code>贴在这里，同时防止显存爆炸，需要设置一些batch。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">copy</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">wandb</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torchmetrics.functional.classification</span> <span class="kn">import</span> <span class="n">binary_matthews_corrcoef</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Bio</span> <span class="kn">import</span> <span class="n">SeqIO</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Bio.Seq</span> <span class="kn">import</span> <span class="n">Seq</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Bio.SeqRecord</span> <span class="kn">import</span> <span class="n">SeqRecord</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">MDAnalysis.analysis.align</span> <span class="kn">import</span> <span class="n">rotation_matrix</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">MDAnalysis.analysis.rms</span> <span class="kn">import</span> <span class="n">rmsd</span> <span class="k">as</span> <span class="n">get_rmsd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">src.data.data_utils</span> <span class="kn">import</span> <span class="n">pdb_to_tensor</span><span class="p">,</span> <span class="n">get_c4p_coords</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">src.data.sec_struct_utils</span> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">predict_sec_struct</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">dotbracket_to_paired</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">dotbracket_to_adjacency</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">src.constants</span> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">NUM_TO_LETTER</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">PROJECT_PATH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">RMSD_THRESHOLD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">TM_THRESHOLD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">GDT_THRESHOLD</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">dataset</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">n_samples</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">temperature</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">device</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">model_name</span><span class="o">=</span><span class="s2">&#34;eval&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;recovery&#39;</span><span class="p">,</span> <span class="s1">&#39;perplexity&#39;</span><span class="p">,</span> <span class="s1">&#39;sc_score_eternafold&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sc_score_ribonanzanet&#39;</span><span class="p">,</span> <span class="s1">&#39;sc_score_rhofold&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">save_designs</span><span class="o">=</span><span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Run evaluation suite for trained RNA inverse folding model on a dataset.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    The following metrics can be computed along with metadata per sample per residue:
</span></span></span><span class="line"><span class="cl"><span class="s2">    1. (recovery) Sequence recovery per residue (taking mean gives per sample recovery)
</span></span></span><span class="line"><span class="cl"><span class="s2">    2. (perplexity) Perplexity per sample
</span></span></span><span class="line"><span class="cl"><span class="s2">    3. (sc_score_eternafold) Secondary structure self-consistency score per sample, 
</span></span></span><span class="line"><span class="cl"><span class="s2">        using EternaFold for secondary structure prediction and computing MCC between
</span></span></span><span class="line"><span class="cl"><span class="s2">        the predicted and groundtruth 2D structures as adjacency matrices.
</span></span></span><span class="line"><span class="cl"><span class="s2">    4. (sc_score_ribonanzanet) Chemical modification self-consistency score per sample,
</span></span></span><span class="line"><span class="cl"><span class="s2">        using RibonanzaNet for chemical modification prediction of the groundtruth and
</span></span></span><span class="line"><span class="cl"><span class="s2">        designed sequences, and measuring MAE between them.
</span></span></span><span class="line"><span class="cl"><span class="s2">    5. (sc_score_rhofold) Tertiary structure self-consistency scores per sample,
</span></span></span><span class="line"><span class="cl"><span class="s2">        using RhoFold for tertiary structure prediction and measuring RMSD, TM-score,
</span></span></span><span class="line"><span class="cl"><span class="s2">        and GDT_TS between the predicted and groundtruth C4&#39; 3D coordinates.
</span></span></span><span class="line"><span class="cl"><span class="s2">    6. (rmsd_within_thresh) Percentage of samples with RMSD within threshold (&lt;=2.0A)
</span></span></span><span class="line"><span class="cl"><span class="s2">    7. (tm_within_thresh) Percentage of samples with TM-score within threshold (&gt;=0.45)
</span></span></span><span class="line"><span class="cl"><span class="s2">    8. (gddt_within_thresh) Percentage of samples with GDT_TS within threshold (&gt;=0.50)
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        model: trained RNA inverse folding model
</span></span></span><span class="line"><span class="cl"><span class="s2">        dataset: dataset to evaluate on
</span></span></span><span class="line"><span class="cl"><span class="s2">        n_samples: number of predicted samples/sequences per data point 
</span></span></span><span class="line"><span class="cl"><span class="s2">        temperature: sampling temperature
</span></span></span><span class="line"><span class="cl"><span class="s2">        device: device to run evaluation on
</span></span></span><span class="line"><span class="cl"><span class="s2">        model_name: name of model/dataset for plotting (default: &#39;eval&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s2">        metrics: list of metrics to compute
</span></span></span><span class="line"><span class="cl"><span class="s2">        save_designs: whether to save designs as fasta with metrics
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns: Dictionary with the following keys:
</span></span></span><span class="line"><span class="cl"><span class="s2">        df: DataFrame with metrics and metadata per residue per sample for analysis and plotting
</span></span></span><span class="line"><span class="cl"><span class="s2">        samples_list: list of tensors of shape (n_samples, seq_len) per data point 
</span></span></span><span class="line"><span class="cl"><span class="s2">        recovery_list: list of mean recovery per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">        perplexity_list: list of mean perplexity per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">        sc_score_eternafold_list: list of 2D self-consistency scores per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">        sc_score_ribonanzanet_list: list of 1D self-consistency scores per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">        sc_score_rmsd_list: list of 3D self-consistency RMSDs per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">        sc_score_tm_list: list of 3D self-consistency TM-scores per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">        sc_score_gddt_list: list of 3D self-consistency GDTs per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">        rmsd_within_thresh_list: list of </span><span class="si">% s</span><span class="s2">cRMSDs within threshold per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">        tm_within_thresh_list: list of </span><span class="si">% s</span><span class="s2">cTMs within threshold per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">        gddt_within_thresh_list: list of </span><span class="si">% s</span><span class="s2">cGDDTs within threshold per data point
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="s1">&#39;recovery&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">,</span> <span class="s1">&#39;Sequence recovery must be computed for evaluation&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#######################################################################</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Optionally initialise other models used for self-consistency scoring</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#######################################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;sc_score_ribonanzanet&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">tools.ribonanzanet.network</span> <span class="kn">import</span> <span class="n">RibonanzaNet</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Initialise RibonanzaNet for self-consistency score</span>
</span></span><span class="line"><span class="cl">        <span class="n">ribonanza_net</span> <span class="o">=</span> <span class="n">RibonanzaNet</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s1">&#39;tools/ribonanzanet/config.yaml&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s1">&#39;tools/ribonanzanet/ribonanzanet.pt&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">device</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Transfer model to device in eval mode</span>
</span></span><span class="line"><span class="cl">        <span class="n">ribonanza_net</span> <span class="o">=</span> <span class="n">ribonanza_net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ribonanza_net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;sc_score_rhofold&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">tools.rhofold.rf</span> <span class="kn">import</span> <span class="n">RhoFold</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">tools.rhofold.config</span> <span class="kn">import</span> <span class="n">rhofold_config</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Initialise RhoFold for 3D self-consistency score</span>
</span></span><span class="line"><span class="cl">        <span class="n">rhofold</span> <span class="o">=</span> <span class="n">RhoFold</span><span class="p">(</span><span class="n">rhofold_config</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">rhofold_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;tools/rhofold/model_20221010_params.pt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Loading RhoFold checkpoint: </span><span class="si">{</span><span class="n">rhofold_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">rhofold</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rhofold_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Transfer model to device in eval mode</span>
</span></span><span class="line"><span class="cl">        <span class="n">rhofold</span> <span class="o">=</span> <span class="n">rhofold</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">rhofold</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">####################################################</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Evaluation loop over each data point sequentially</span>
</span></span><span class="line"><span class="cl">    <span class="c1">####################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># per sample metric lists for storing evaluation results</span>
</span></span><span class="line"><span class="cl">    <span class="n">samples_list</span> <span class="o">=</span> <span class="p">[]</span>               <span class="c1"># list of tensors of shape (n_samples, seq_len) per data point </span>
</span></span><span class="line"><span class="cl">    <span class="n">recovery_list</span> <span class="o">=</span> <span class="p">[]</span>              <span class="c1"># list of mean recovery per data point</span>
</span></span><span class="line"><span class="cl">    <span class="n">perplexity_list</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># list of mean perplexity per data point</span>
</span></span><span class="line"><span class="cl">    <span class="n">sc_score_ribonanzanet_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of 1D self-consistency scores per data point</span>
</span></span><span class="line"><span class="cl">    <span class="n">sc_score_eternafold_list</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># list of 2D self-consistency scores per data point</span>
</span></span><span class="line"><span class="cl">    <span class="n">sc_score_rmsd_list</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># list of 3D self-consistency RMSDs per data point</span>
</span></span><span class="line"><span class="cl">    <span class="n">rmsd_within_thresh_list</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># list of % scRMSDs within threshold per data point</span>
</span></span><span class="line"><span class="cl">    <span class="n">sc_score_tm_list</span> <span class="o">=</span> <span class="p">[]</span>           <span class="c1"># list of 3D self-consistency TM-scores per data point</span>
</span></span><span class="line"><span class="cl">    <span class="n">tm_within_thresh_list</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># list of % scTMs within threshold per data point</span>
</span></span><span class="line"><span class="cl">    <span class="n">sc_score_gddt_list</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># list of 3D self-consistency GDTs per data point</span>
</span></span><span class="line"><span class="cl">    <span class="n">gddt_within_thresh_list</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># list of % scGDDTs within threshold per data point</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># DataFrame to store metrics and metadata per residue per sample for analysis and plotting</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">,</span> <span class="s1">&#39;recovery&#39;</span><span class="p">,</span> <span class="s1">&#39;sasa&#39;</span><span class="p">,</span> <span class="s1">&#39;paired&#39;</span><span class="p">,</span> <span class="s1">&#39;rmsds&#39;</span><span class="p">,</span> <span class="s1">&#39;model_name&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;xpu&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">intel_extension_for_pytorch</span> <span class="k">as</span> <span class="nn">ipex</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span> <span class="o">=</span> <span class="n">ipex</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s1">&#39;sc_score_ribonanzanet&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ribonanza_net</span> <span class="o">=</span> <span class="n">ipex</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">ribonanza_net</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s1">&#39;sc_score_rhofold&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">rhofold</span> <span class="o">=</span> <span class="n">ipex</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">rhofold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">raw_data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_list</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># featurise raw data</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">featurizer</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># sample n_samples from model for single data point: n_samples x seq_len</span>
</span></span><span class="line"><span class="cl">            <span class="n">samples</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">return_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">samples_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># perplexity per sample: n_samples x 1</span>
</span></span><span class="line"><span class="cl">            <span class="n">n_nodes</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">perplexity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">n_nodes</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">out_dim</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                <span class="n">samples</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">n_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">                <span class="n">reduction</span><span class="o">=</span><span class="s2">&#34;none&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_nodes</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">perplexity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perplexity</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">###########</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Metadata</span>
</span></span><span class="line"><span class="cl">            <span class="c1">###########</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># per residue average SASA: seq_len x 1</span>
</span></span><span class="line"><span class="cl">            <span class="n">mask_coords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mask_coords</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">sasa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;sasa_list&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">mask_coords</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># per residue indicator for paired/unpaired: seq_len x 1</span>
</span></span><span class="line"><span class="cl">            <span class="n">paired</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="p">[</span><span class="n">dotbracket_to_paired</span><span class="p">(</span><span class="n">sec_struct</span><span class="p">)</span> <span class="k">for</span> <span class="n">sec_struct</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;sec_struct_list&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">)[</span><span class="n">mask_coords</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># per residue average RMSD: seq_len x 1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&#34;coords_list&#34;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">rmsds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sasa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">rmsds</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&#34;coords_list&#34;</span><span class="p">])):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&#34;coords_list&#34;</span><span class="p">])):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">coords_i</span> <span class="o">=</span> <span class="n">get_c4p_coords</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&#34;coords_list&#34;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="n">coords_j</span> <span class="o">=</span> <span class="n">get_c4p_coords</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&#34;coords_list&#34;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="n">rmsds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">coords_i</span> <span class="o">-</span> <span class="n">coords_j</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">rmsds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">rmsds</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">mask_coords</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">##########</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Metrics</span>
</span></span><span class="line"><span class="cl">            <span class="c1">##########</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># sequence recovery per residue across all samples: n_samples x seq_len </span>
</span></span><span class="line"><span class="cl">            <span class="n">recovery</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">recovery_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recovery</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># update per residue per sample dataframe</span>
</span></span><span class="line"><span class="cl">            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                <span class="n">df</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">recovery</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;recovery&#39;</span><span class="p">:</span> <span class="n">recovery</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;sasa&#39;</span><span class="p">:</span> <span class="n">sasa</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;paired&#39;</span><span class="p">:</span> <span class="n">paired</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;rmsds&#39;</span><span class="p">:</span> <span class="n">rmsds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">recovery</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># global 2D self consistency score per sample: n_samples x 1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;sc_score_eternafold&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">sc_score_eternafold</span><span class="p">,</span> <span class="n">pred_sec_structs</span> <span class="o">=</span> <span class="n">self_consistency_score_eternafold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">samples</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;sec_struct_list&#39;</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">mask_coords</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">return_sec_structs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sc_score_eternafold_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc_score_eternafold</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># global 1D self consistency score per sample: n_samples x 1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;sc_score_ribonanzanet&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">sc_score_ribonanzanet</span><span class="p">,</span> <span class="n">pred_chem_mods</span> <span class="o">=</span> <span class="n">self_consistency_score_ribonanzanet</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">samples</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mask_coords</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">ribonanza_net</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">return_chem_mods</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sc_score_ribonanzanet_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc_score_ribonanzanet</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># global 3D self consistency scores per sample: n_samples x 1, each</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;sc_score_rhofold&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;designs_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">current_datetime</span><span class="si">}</span><span class="s2">/sample</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;designs_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">current_datetime</span><span class="si">}</span><span class="s2">/sample</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">sc_score_rmsd</span><span class="p">,</span> <span class="n">sc_score_tm</span><span class="p">,</span> <span class="n">sc_score_gdt</span> <span class="o">=</span> <span class="n">self_consistency_score_rhofold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">samples</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">raw_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mask_coords</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rhofold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">output_dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">save_designs</span> <span class="o">=</span> <span class="n">save_designs</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sc_score_rmsd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc_score_rmsd</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">sc_score_tm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc_score_tm</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">sc_score_gddt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc_score_gdt</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">rmsd_within_thresh_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sc_score_rmsd</span> <span class="o">&lt;=</span> <span class="n">RMSD_THRESHOLD</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_samples</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">tm_within_thresh_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sc_score_tm</span> <span class="o">&gt;=</span> <span class="n">TM_THRESHOLD</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_samples</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">gddt_within_thresh_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sc_score_gdt</span> <span class="o">&gt;=</span> <span class="n">GDT_THRESHOLD</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_samples</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">save_designs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># collate designed sequences in fasta format</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">SeqRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">Seq</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&#34;sequence&#34;</span><span class="p">]),</span> <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;input_sequence,&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;pdb_id=</span><span class="si">{</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;id_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> rfam=</span><span class="si">{</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;rfam_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> eq_class=</span><span class="si">{</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;eq_class_list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> cluster=</span><span class="si">{</span><span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;cluster_structsim0.45&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">zipped</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">samples</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">perplexity</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">recovery</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sc_score_eternafold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pred_sec_structs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sc_score_ribonanzanet</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pred_chem_mods</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sc_score_rmsd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sc_score_tm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sc_score_gdt</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">seq</span><span class="p">,</span> <span class="n">perp</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">pred_ss</span><span class="p">,</span> <span class="n">sc_ribo</span><span class="p">,</span> <span class="n">pred_cm</span><span class="p">,</span> <span class="n">sc_rmsd</span><span class="p">,</span> <span class="n">sc_tm</span><span class="p">,</span> <span class="n">sc_gdt</span> <span class="o">=</span> <span class="n">zipped</span>
</span></span><span class="line"><span class="cl">                        <span class="n">seq</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">NUM_TO_LETTER</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="n">edit_dist</span> <span class="o">=</span> <span class="n">edit_distance</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SeqRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">Seq</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;sample=</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">,&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;temperature=</span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s2"> perplexity=</span><span class="si">{</span><span class="n">perp</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> recovery=</span><span class="si">{</span><span class="n">rec</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> edit_dist=</span><span class="si">{</span><span class="n">edit_dist</span><span class="si">}</span><span class="s2"> sc_score=</span><span class="si">{</span><span class="n">sc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> sc_score_ribonanzanet=</span><span class="si">{</span><span class="n">sc_ribo</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> sc_score_rmsd=</span><span class="si">{</span><span class="n">sc_rmsd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> sc_score_tm=</span><span class="si">{</span><span class="n">sc_tm</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> sc_score_gdt=</span><span class="si">{</span><span class="n">sc_gdt</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># write all designed sequences to output filepath</span>
</span></span><span class="line"><span class="cl">                    <span class="n">SeqIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&#34;all_designs.fasta&#34;</span><span class="p">),</span> <span class="s2">&#34;fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;df&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;samples_list&#39;</span><span class="p">:</span> <span class="n">samples_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;recovery_list&#39;</span><span class="p">:</span> <span class="n">recovery_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;perplexity_list&#39;</span><span class="p">:</span> <span class="n">perplexity_list</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;sc_score_eternafold&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sc_score_eternafold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc_score_eternafold_list</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;sc_score_ribonanzanet&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sc_score_ribonanzanet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc_score_ribonanzanet_list</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;sc_score_rhofold&#39;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sc_score_rmsd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc_score_rmsd_list</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sc_score_tm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc_score_tm_list</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;sc_score_gddt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc_score_gddt_list</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;rmsd_within_thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmsd_within_thresh_list</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;tm_within_thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tm_within_thresh_list</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;gddt_within_thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gddt_within_thresh_list</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># =========================================================</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">gc</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;ribonanza_net&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">del</span> <span class="n">ribonanza_net</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;rhofold&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">del</span> <span class="n">rhofold</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># =========================================================</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">self_consistency_score_eternafold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">samples</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">true_sec_struct_list</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">mask_coords</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">n_samples_ss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_to_letter</span> <span class="o">=</span> <span class="n">NUM_TO_LETTER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">return_sec_structs</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Compute self consistency score for an RNA, given its true secondary structure(s)
</span></span></span><span class="line"><span class="cl"><span class="s2">    and a list of designed sequences. 
</span></span></span><span class="line"><span class="cl"><span class="s2">    EternaFold is used to &#39;forward fold&#39; the designs.
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        samples: designed sequences of shape (n_samples, seq_len)
</span></span></span><span class="line"><span class="cl"><span class="s2">        true_sec_struct_list: list of true secondary structures (n_true_ss, seq_len)
</span></span></span><span class="line"><span class="cl"><span class="s2">        mask_coords: mask for missing sequence coordinates to be ignored during evaluation
</span></span></span><span class="line"><span class="cl"><span class="s2">        n_samples_ss: number of predicted secondary structures per designed sample
</span></span></span><span class="line"><span class="cl"><span class="s2">        num_to_letter: lookup table mapping integers to nucleotides
</span></span></span><span class="line"><span class="cl"><span class="s2">        return_sec_structs: whether to return the predicted secondary structures
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Workflow:
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Input: For a given RNA molecule, we are given:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Designed sequences of shape (n_samples, seq_len)
</span></span></span><span class="line"><span class="cl"><span class="s2">        - True secondary structure(s) of shape (n_true_ss, seq_len)
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        For each designed sequence:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Predict n_sample_ss secondary structures using EternaFold
</span></span></span><span class="line"><span class="cl"><span class="s2">        - For each pair of true and predicted secondary structures:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Compute MCC score between their adjacency matrix representations
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Take the average MCC score across all n_sample_ss predicted structures
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Take the average MCC score across all n_samples designed sequences
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">n_true_ss</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_sec_struct_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sequence_length</span> <span class="o">=</span> <span class="n">mask_coords</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># map all entries from dotbracket to numerical representation</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_sec_struct_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dotbracket_to_adjacency</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">true_sec_struct_list</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># mask out missing sequence coordinates</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_sec_struct_list</span> <span class="o">=</span> <span class="n">true_sec_struct_list</span><span class="p">[:,</span> <span class="n">mask_coords</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">mask_coords</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># reshape to (n_true_ss * n_samples_ss, seq_len, seq_len)</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_sec_struct_list</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">true_sec_struct_list</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_samples_ss</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mcc_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">pred_sec_structs</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># convert sample to string</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">num_to_letter</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">_sample</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># predict secondary structure(s) for each sample</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred_sec_struct_list</span> <span class="o">=</span> <span class="n">predict_sec_struct</span><span class="p">(</span><span class="n">pred_seq</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples_ss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">return_sec_structs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pred_sec_structs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pred_sec_struct_list</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># map all entries from dotbracket to numerical representation</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred_sec_struct_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dotbracket_to_adjacency</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">pred_sec_struct_list</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># reshape to (n_samples_ss * n_true_ss, seq_len, seq_len)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred_sec_struct_list</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">pred_sec_struct_list</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_true_ss</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># compute mean MCC score between pairs of true and predicted secondary structures</span>
</span></span><span class="line"><span class="cl">        <span class="n">mcc_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">binary_matthews_corrcoef</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">pred_sec_struct_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">true_sec_struct_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">return_sec_structs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mcc_scores</span><span class="p">),</span> <span class="n">pred_sec_structs</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mcc_scores</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">self_consistency_score_ribonanzanet</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">samples</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_sequence</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask_seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ribonanza_net</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_to_letter</span><span class="o">=</span><span class="n">NUM_TO_LETTER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">return_chem_mods</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Compute self consistency score for an RNA, given the (predicted) chemical modifications for
</span></span></span><span class="line"><span class="cl"><span class="s2">    the original RNA and a list of designed sequences. RibonanzaNet is used to &#39;forward fold&#39; the
</span></span></span><span class="line"><span class="cl"><span class="s2">    designs.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        samples: designed sequences of shape (n_samples, seq_len)
</span></span></span><span class="line"><span class="cl"><span class="s2">        true_sequence: true RNA sequence used to predict chemical modifications
</span></span></span><span class="line"><span class="cl"><span class="s2">        mask_seq: mask for missing sequence coordinates to be ignored during evaluation
</span></span></span><span class="line"><span class="cl"><span class="s2">        ribonanza_net: RibonanzaNet model
</span></span></span><span class="line"><span class="cl"><span class="s2">        num_to_letter: lookup table mapping integers to nucleotides
</span></span></span><span class="line"><span class="cl"><span class="s2">        return_chem_mods: whether to return the predicted chemical modifications
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Workflow:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Input: For a given RNA molecule, we are given:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Designed sequences of shape (n_samples, seq_len)
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Predicted chemical modifications for original sequence,
</span></span></span><span class="line"><span class="cl"><span class="s2">          of shape (n_samples, seq_len, 2), predicted via RibonanzaNet, of which we take
</span></span></span><span class="line"><span class="cl"><span class="s2">          the index 0 from the last channal --&gt; 2A3/SHAPE.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        For each designed sequence:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Predict chemical modifications using RibonanzaNet
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Compute mean absolute error between prediction and chemical modifications for
</span></span></span><span class="line"><span class="cl"><span class="s2">          the original sequence
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        Take the average mean absolute error across all n_samples designed sequences
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Compute original sequence&#39;s chemical modifications using RibonanzaNet</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">char</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">true_sequence</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_sequence</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">true_sequence</span><span class="p">[</span><span class="n">mask_seq</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_chem_mod</span> <span class="o">=</span> <span class="n">ribonanza_net</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">true_sequence</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,:,</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1"># 2. 【核心修改】分批处理模型生成的样本</span>
</span></span><span class="line"><span class="cl">    <span class="n">_samples_char</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">num_to_letter</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">]</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 定义一个小的批次大小，可以根据显存调整（比如4, 8, 16）</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_preds</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 用于收集所有批次的预测结果</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">_samples_char</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 取出一个小批次</span>
</span></span><span class="line"><span class="cl">        <span class="n">batch_samples</span> <span class="o">=</span> <span class="n">_samples_char</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 对这个小批次进行预测</span>
</span></span><span class="line"><span class="cl">        <span class="n">batch_pred</span> <span class="o">=</span> <span class="n">ribonanza_net</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch_samples</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,:,</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">all_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_pred</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 将所有批次的结果拼接起来</span>
</span></span><span class="line"><span class="cl">    <span class="n">pred_chem_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1"># _samples_char = np.array([[num_to_letter[num] for num in seq] for seq in samples])</span>
</span></span><span class="line"><span class="cl">   <span class="c1"># _samples = np.array([[num_to_letter[num] for num in seq] for seq in samples])</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#pred_chem_mod = ribonanza_net.predict(_samples_char).cpu().numpy()[:,:,0]</span>
</span></span><span class="line"><span class="cl">   <span class="c1">##pred_chem_mod = ribonanza_net.predict(_samples[:, mask_seq]).cpu().numpy()[:,:,0]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">return_chem_mods</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred_chem_mod</span> <span class="o">-</span> <span class="n">true_chem_mod</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">pred_chem_mod</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pred_chem_mod</span> <span class="o">-</span> <span class="n">true_chem_mod</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">self_consistency_score_ribonanzanet_sec_struct</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">samples</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">true_sec_struct</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">mask_coords</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">ribonanza_net_ss</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_to_letter</span> <span class="o">=</span> <span class="n">NUM_TO_LETTER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">return_sec_structs</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># map from dotbracket to numerical representation</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_sec_struct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dotbracket_to_adjacency</span><span class="p">(</span><span class="n">true_sec_struct</span><span class="p">,</span> <span class="n">keep_pseudoknots</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># mask out missing sequence coordinates</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_sec_struct</span> <span class="o">=</span> <span class="n">true_sec_struct</span><span class="p">[</span><span class="n">mask_coords</span><span class="p">][:,</span> <span class="n">mask_coords</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># (n_samples, seq_len, seq_len)</span>
</span></span><span class="line"><span class="cl">    <span class="n">true_sec_struct</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">true_sec_struct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">num_to_letter</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">]</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">_</span><span class="p">,</span> <span class="n">pred_sec_structs</span> <span class="o">=</span> <span class="n">ribonanza_net_ss</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_samples</span><span class="p">)</span>  <span class="c1"># (n_samples, seq_len, seq_len)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">mcc_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pred_sec_struct</span> <span class="ow">in</span> <span class="n">pred_sec_structs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># map from dotbracket to numerical representation</span>
</span></span><span class="line"><span class="cl">        <span class="n">pred_sec_struct</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dotbracket_to_adjacency</span><span class="p">(</span><span class="n">pred_sec_struct</span><span class="p">,</span> <span class="n">keep_pseudoknots</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># compute mean MCC score between pairs of true and predicted secondary structures</span>
</span></span><span class="line"><span class="cl">        <span class="n">mcc_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">binary_matthews_corrcoef</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">pred_sec_struct</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">true_sec_struct</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">return_sec_structs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mcc_scores</span><span class="p">),</span> <span class="n">pred_sec_structs</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mcc_scores</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">self_consistency_score_rhofold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">samples</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">true_raw_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask_coords</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">rhofold</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">output_dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_to_letter</span> <span class="o">=</span> <span class="n">NUM_TO_LETTER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">save_designs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">save_pdbs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">use_relax</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Compute self consistency score for an RNA, given its true 3D structure(s)
</span></span></span><span class="line"><span class="cl"><span class="s2">    for the original RNA and a list of designed sequences.
</span></span></span><span class="line"><span class="cl"><span class="s2">    RhoFold is used to &#39;forward fold&#39; the designs.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Credit: adapted from Rishabh Anand
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        samples: designed sequences of shape (n_samples, seq_len)
</span></span></span><span class="line"><span class="cl"><span class="s2">        true_raw_data: Original RNA raw data with 3D structure(s) in `coords_list`
</span></span></span><span class="line"><span class="cl"><span class="s2">        mask_coords: mask for missing sequence coordinates to be ignored during evaluation
</span></span></span><span class="line"><span class="cl"><span class="s2">        rhofold: RhoFold model
</span></span></span><span class="line"><span class="cl"><span class="s2">        output_dir: directory to save designed sequences and structures
</span></span></span><span class="line"><span class="cl"><span class="s2">        num_to_letter: lookup table mapping integers to nucleotides
</span></span></span><span class="line"><span class="cl"><span class="s2">        save_designs: whether to save designs as fasta to output directory
</span></span></span><span class="line"><span class="cl"><span class="s2">        save_pdbs: whether to save PDBs of forward-folded designs to output directory
</span></span></span><span class="line"><span class="cl"><span class="s2">        use_relax: whether to perform Amber relaxation on designed structures
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Workflow:
</span></span></span><span class="line"><span class="cl"><span class="s2">            
</span></span></span><span class="line"><span class="cl"><span class="s2">        Input: For a given RNA molecule, we are given:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Designed sequences of shape (n_samples, seq_len)
</span></span></span><span class="line"><span class="cl"><span class="s2">        - True 3D structure(s) of shape (n_true_structs, seq_len, 3)
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        For each designed sequence:
</span></span></span><span class="line"><span class="cl"><span class="s2">        - Predict the tertiary structure using RhoFold
</span></span></span><span class="line"><span class="cl"><span class="s2">        - For each pair of true and predicted 3D structures:
</span></span></span><span class="line"><span class="cl"><span class="s2">            - Compute RMSD, TM-score &amp; GDT between their C4&#39; coordinates
</span></span></span><span class="line"><span class="cl"><span class="s2">        
</span></span></span><span class="line"><span class="cl"><span class="s2">        Take the average self-consistency scores across all n_samples designed sequences
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        sc_rmsds: array of RMSD scores per sample
</span></span></span><span class="line"><span class="cl"><span class="s2">        sc_tms: array of TM-score scores per sample
</span></span></span><span class="line"><span class="cl"><span class="s2">        sc_gddts: array of GDT scores per sample
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Collate designed sequences in fasta format</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># first record: input sequence and model metadata</span>
</span></span><span class="line"><span class="cl">    <span class="n">input_seq</span> <span class="o">=</span> <span class="n">SeqRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">Seq</span><span class="p">(</span><span class="n">true_raw_data</span><span class="p">[</span><span class="s2">&#34;sequence&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;input_sequence,&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;input_sequence&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># SeqIO.write(input_seq, os.path.join(output_dir, &#34;input_seq.fasta&#34;), &#34;fasta&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_seq</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># remaining records: designed sequences and metrics</span>
</span></span><span class="line"><span class="cl">    <span class="n">sc_rmsds</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">sc_tms</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">sc_gddts</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Save designed sequence to fasta file (temporary)</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq</span> <span class="o">=</span> <span class="n">SeqRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Seq</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">num_to_letter</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">])),</span> 
</span></span><span class="line"><span class="cl">            <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;sample=</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">,&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;sample=</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">design_fasta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;design</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">SeqIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">design_fasta_path</span><span class="p">,</span> <span class="s2">&#34;fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Forward fold designed sequence using RhoFold</span>
</span></span><span class="line"><span class="cl">        <span class="n">design_pdb_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;design</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.pdb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">rhofold</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">design_fasta_path</span><span class="p">,</span> <span class="n">design_pdb_path</span><span class="p">,</span> <span class="n">use_relax</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Load C4&#39; coordinates of designed structure</span>
</span></span><span class="line"><span class="cl">        <span class="n">_</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pdb_to_tensor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">design_pdb_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">return_sec_struct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">return_sasa</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">keep_insertions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">coords</span> <span class="o">=</span> <span class="n">get_c4p_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># zero-center coordinates</span>
</span></span><span class="line"><span class="cl">        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Compute self-consistency between designed and groundtruth structures</span>
</span></span><span class="line"><span class="cl">        <span class="n">_sc_rmsds</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">_sc_tms</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">_sc_gddts</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">other_coords</span> <span class="ow">in</span> <span class="n">true_raw_data</span><span class="p">[</span><span class="s2">&#34;coords_list&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">_other</span> <span class="o">=</span> <span class="n">get_c4p_coords</span><span class="p">(</span><span class="n">other_coords</span><span class="p">)[</span><span class="n">mask_coords</span><span class="p">,</span> <span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># zero-center other coordinates</span>
</span></span><span class="line"><span class="cl">            <span class="n">_other</span> <span class="o">=</span> <span class="n">_other</span> <span class="o">-</span> <span class="n">_other</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># globally align coordinates</span>
</span></span><span class="line"><span class="cl">            <span class="n">R_hat</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_other</span><span class="p">,</span>  <span class="c1"># mobile set</span>
</span></span><span class="line"><span class="cl">                <span class="n">coords</span> <span class="c1"># reference set</span>
</span></span><span class="line"><span class="cl">            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">_other</span> <span class="o">=</span> <span class="n">_other</span> <span class="o">@</span> <span class="n">R_hat</span><span class="o">.</span><span class="n">T</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># compute metrics</span>
</span></span><span class="line"><span class="cl">            <span class="n">_sc_rmsds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_rmsd</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">coords</span><span class="p">,</span> <span class="n">_other</span><span class="p">,</span> <span class="n">superposition</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">_sc_tms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_tmscore</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">_other</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">_sc_gddts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_gddt</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">_other</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">sc_rmsds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_sc_rmsds</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">sc_tms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_sc_tms</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">sc_gddts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_sc_gddts</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># remove temporary files</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">design_fasta_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">save_pdbs</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">design_pdb_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">save_designs</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># remove output directory        </span>
</span></span><span class="line"><span class="cl">        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># write all designed sequences to output filepath</span>
</span></span><span class="line"><span class="cl">        <span class="n">SeqIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&#34;all_designs.fasta&#34;</span><span class="p">),</span> <span class="s2">&#34;fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sc_rmsds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sc_tms</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sc_gddts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_tmscore</span><span class="p">(</span><span class="n">y_hat</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Template Modelling score (TM-score). 
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Credit: Arian Jamasb, graphein (https://github.com/a-r-j/graphein)
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    https://en.wikipedia.org/wiki/Template_modeling_score
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    TM-score is a measure of similarity between two protein structures.
</span></span></span><span class="line"><span class="cl"><span class="s2">    The TM-score is intended as a more accurate measure of the global
</span></span></span><span class="line"><span class="cl"><span class="s2">    similarity of full-length protein structures than the often used RMSD
</span></span></span><span class="line"><span class="cl"><span class="s2">    measure. The TM-score indicates the similarity between two structures
</span></span></span><span class="line"><span class="cl"><span class="s2">    by a score between ``[0, 1]``, where 1 indicates a perfect match
</span></span></span><span class="line"><span class="cl"><span class="s2">    between two structures (thus the higher the better). Generally scores
</span></span></span><span class="line"><span class="cl"><span class="s2">    below 0.20 corresponds to randomly chosen unrelated proteins whereas
</span></span></span><span class="line"><span class="cl"><span class="s2">    structures with a score higher than 0.5 assume roughly the same fold.
</span></span></span><span class="line"><span class="cl"><span class="s2">    A quantitative study shows that proteins of TM-score = 0.5 have a
</span></span></span><span class="line"><span class="cl"><span class="s2">    posterior probability of 37</span><span class="si">% i</span><span class="s2">n the same CATH topology family and of
</span></span></span><span class="line"><span class="cl"><span class="s2">    13</span><span class="si">% i</span><span class="s2">n the same SCOP fold family. The probabilities increase rapidly
</span></span></span><span class="line"><span class="cl"><span class="s2">    when TM-score &gt; 0.5. The TM-score is designed to be independent of
</span></span></span><span class="line"><span class="cl"><span class="s2">    protein lengths.
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    We have adapted the implementation to RNA (TM-score threshold = 0.45).
</span></span></span><span class="line"><span class="cl"><span class="s2">    Requires aligned C4&#39; coordinates as input.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">l_target</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">d0_l_target</span> <span class="o">=</span> <span class="mf">1.24</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">l_target</span> <span class="o">-</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.8</span>
</span></span><span class="line"><span class="cl">    <span class="n">di</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pairwise_distance</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">di</span> <span class="o">/</span> <span class="n">d0_l_target</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">l_target</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_gddt</span><span class="p">(</span><span class="n">y_hat</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Global Distance Deviation Test metric (GDDT).
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Credit: Arian Jamasb, graphein (https://github.com/a-r-j/graphein)
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    https://en.wikipedia.org/wiki/Global_distance_test
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    The GDT score is calculated as the largest set of amino acid residues&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">    alpha carbon atoms in the model structure falling within a defined
</span></span></span><span class="line"><span class="cl"><span class="s2">    distance cutoff of their position in the experimental structure, after
</span></span></span><span class="line"><span class="cl"><span class="s2">    iteratively superimposing the two structures. By the original design the
</span></span></span><span class="line"><span class="cl"><span class="s2">    GDT algorithm calculates 20 GDT scores, i.e. for each of 20 consecutive distance
</span></span></span><span class="line"><span class="cl"><span class="s2">    cutoffs (``0.5 Å, 1.0 Å, 1.5 Å, ... 10.0 Å``). For structure similarity assessment
</span></span></span><span class="line"><span class="cl"><span class="s2">    it is intended to use the GDT scores from several cutoff distances, and scores
</span></span></span><span class="line"><span class="cl"><span class="s2">    generally increase with increasing cutoff. A plateau in this increase may
</span></span></span><span class="line"><span class="cl"><span class="s2">    indicate an extreme divergence between the experimental and predicted structures,
</span></span></span><span class="line"><span class="cl"><span class="s2">    such that no additional atoms are included in any cutoff of a reasonable distance.
</span></span></span><span class="line"><span class="cl"><span class="s2">    The conventional GDT_TS total score in CASP is the average result of cutoffs at
</span></span></span><span class="line"><span class="cl"><span class="s2">    ``1``, ``2``, ``4``, and ``8`` Å.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Random predictions give around 20; getting the gross topology right gets one to ~50; 
</span></span></span><span class="line"><span class="cl"><span class="s2">    accurate topology is usually around 70; and when all the little bits and pieces, 
</span></span></span><span class="line"><span class="cl"><span class="s2">    including side-chain conformations, are correct, GDT_TS begins to climb above 90.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    We have adapted the implementation to RNA.
</span></span></span><span class="line"><span class="cl"><span class="s2">    Requires aligned C4&#39; coordinates as input.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Get distance between points</span>
</span></span><span class="line"><span class="cl">    <span class="n">dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Return mean fraction of distances below cutoff for each cutoff (1, 2, 4, 8)</span>
</span></span><span class="line"><span class="cl">    <span class="n">count_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">dist</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">count_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">dist</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">count_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">dist</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">count_8</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">dist</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">count_1</span><span class="p">,</span> <span class="n">count_2</span><span class="p">,</span> <span class="n">count_4</span><span class="p">,</span> <span class="n">count_8</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_distance</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    A Space efficient Dynamic Programming based Python3 program 
</span></span></span><span class="line"><span class="cl"><span class="s2">    to find minimum number operations to convert str1 to str2
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Source: https://www.geeksforgeeks.org/edit-distance-dp-5/
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">prev</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">curr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">curr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mn</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">prev</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">curr</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">curr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">prev</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev</span> <span class="o">=</span> <span class="n">curr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">prev</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>除此之外，需要加一层简单的attention，<code>models.py</code>代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">################################################################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Generalisation of Geometric Vector Perceptron, Jing et al.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for explicit multi-state biomolecule representation learning.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Original repository: https://github.com/drorlab/gvp-pytorch</span>
</span></span><span class="line"><span class="cl"><span class="c1">################################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">Categorical</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch_geometric</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">src.layers</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AutoregressiveMultiGNNv1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Autoregressive GVP-GNN for **multiple** structure-conditioned RNA design.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    Takes in RNA structure graphs of type `torch_geometric.data.Data` 
</span></span></span><span class="line"><span class="cl"><span class="s1">    or `torch_geometric.data.Batch` and returns a categorical distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">    over 4 bases at each position in a `torch.Tensor` of shape [n_nodes, 4].
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    The standard forward pass requires sequence information as input
</span></span></span><span class="line"><span class="cl"><span class="s1">    and should be used for training or evaluating likelihood.
</span></span></span><span class="line"><span class="cl"><span class="s1">    For sampling or design, use `self.sample`.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): node dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_h_dim (tuple): node dimensions to use in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): edge dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        edge_h_dim (tuple): edge dimensions to embed in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        num_layers (int): number of GVP-GNN layers in encoder/decoder
</span></span></span><span class="line"><span class="cl"><span class="s1">        drop_rate (float): rate to use in all dropout layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        out_dim (int): output dimension (4 bases)
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">node_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">drop_rate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">out_dim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span> <span class="o">=</span> <span class="n">node_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span> <span class="o">=</span> <span class="n">node_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span> <span class="o">=</span> <span class="n">edge_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span> <span class="o">=</span> <span class="n">edge_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span> <span class="o">=</span> <span class="n">out_dim</span>
</span></span><span class="line"><span class="cl">        <span class="n">activations</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">silu</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Node input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Edge input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Encoder layers (supports multiple conformations)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">MultiGVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Simple self-attention on pooled scalar node features</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">embed_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Decoder layers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">GVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                             <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">autoregressive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Output</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span> <span class="o">=</span> <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">seq</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Pool multi-conformation features: </span>
</span></span><span class="line"><span class="cl">        <span class="c1"># nodes: (n_nodes, d_s), (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_multi_conf</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply simple self-attention over nodes (sequence length = n_nodes)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">need_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">attn_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">encoder_embeddings</span> <span class="o">=</span> <span class="n">h_V</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_s</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span> <span class="o">=</span> <span class="n">h_S</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_S</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">autoregressive_x</span> <span class="o">=</span> <span class="n">encoder_embeddings</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logits</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@torch.no_grad</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">batch</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">n_samples</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">logit_bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">return_logits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        Samples sequences autoregressively from the distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">        learned by the model.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">            batch (torch_geometric.data.Data): mini-batch containing one
</span></span></span><span class="line"><span class="cl"><span class="s1">                RNA backbone to design sequences for
</span></span></span><span class="line"><span class="cl"><span class="s1">            n_samples (int): number of samples
</span></span></span><span class="line"><span class="cl"><span class="s1">            temperature (float): temperature to use in softmax over 
</span></span></span><span class="line"><span class="cl"><span class="s1">                the categorical distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">            logit_bias (torch.Tensor): bias to add to logits during sampling
</span></span></span><span class="line"><span class="cl"><span class="s1">                to manually fix or control nucleotides in designed sequences,
</span></span></span><span class="line"><span class="cl"><span class="s1">                of shape [n_nodes, 4]
</span></span></span><span class="line"><span class="cl"><span class="s1">            return_logits (bool): whether to return logits or not
</span></span></span><span class="line"><span class="cl"><span class="s1">        
</span></span></span><span class="line"><span class="cl"><span class="s1">        Returns:
</span></span></span><span class="line"><span class="cl"><span class="s1">            seq (torch.Tensor): int tensor of shape [n_samples, n_nodes]
</span></span></span><span class="line"><span class="cl"><span class="s1">                                based on the residue-to-int mapping of
</span></span></span><span class="line"><span class="cl"><span class="s1">                                the original training data
</span></span></span><span class="line"><span class="cl"><span class="s1">            logits (torch.Tensor): logits of shape [n_samples, n_nodes, 4]
</span></span></span><span class="line"><span class="cl"><span class="s1">                                   (only if return_logits is True)
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#39;&#39;&#39;</span> 
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="n">device</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">device</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Pool multi-conformation features</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># nodes: (n_nodes, d_s), (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_multi_conf</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply simple self-attention over nodes (sequence length = n_nodes)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">need_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">attn_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Repeat features for sampling n_samples times</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Expand edge index for autoregressive decoding</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="n">num_nodes</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">edge_index</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># This is akin to &#39;batching&#39; (in PyG style) n_samples copies of the graph</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V_cache</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Decode one token at a time</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">h_S_</span> <span class="o">=</span> <span class="n">h_S</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_S_</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E_</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_S_</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">            <span class="n">edge_mask</span> <span class="o">=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">num_nodes</span> <span class="o">==</span> <span class="n">i</span>  <span class="c1"># True for all edges where dst is node i</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_index_</span> <span class="o">=</span> <span class="n">edge_index</span><span class="p">[:,</span> <span class="n">edge_mask</span><span class="p">]</span>  <span class="c1"># subset all incoming edges to node i</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E_</span> <span class="o">=</span> <span class="n">tuple_index</span><span class="p">(</span><span class="n">h_E_</span><span class="p">,</span> <span class="n">edge_mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">node_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">node_mask</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># True for all nodes i and its repeats</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V_cache</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">edge_index_</span><span class="p">,</span> <span class="n">h_E_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">autoregressive_x</span><span class="o">=</span><span class="n">h_V_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node_mask</span><span class="o">=</span><span class="n">node_mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="n">tuple_index</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">node_mask</span><span class="p">)</span>  <span class="c1"># subset out to only node i and its repeats</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">h_V_cache</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">h_V_cache</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="n">lgts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Add logit bias if provided to fix or bias positions</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">logit_bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">lgts</span> <span class="o">+=</span> <span class="n">logit_bias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Sample from logits</span>
</span></span><span class="line"><span class="cl">            <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">lgts</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_S</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_s</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">return_logits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">),</span> <span class="n">logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>    
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">pool_multi_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Number of conformations is 1, no need to pool</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># True num_conf for masked mean pooling</span>
</span></span><span class="line"><span class="cl">        <span class="n">n_conf_true</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (n_nodes, 1)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask scalar features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V0</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E0</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask vector features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V1</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E1</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Average pooling multi-conformation features</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">,</span>               <span class="c1"># (n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_V1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_E0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>               <span class="c1"># (n_edges, d_se)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_E1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NonAutoregressiveMultiGNNv1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Non-Autoregressive GVP-GNN for **multiple** structure-conditioned RNA design.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    Takes in RNA structure graphs of type `torch_geometric.data.Data` 
</span></span></span><span class="line"><span class="cl"><span class="s1">    or `torch_geometric.data.Batch` and returns a categorical distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">    over 4 bases at each position in a `torch.Tensor` of shape [n_nodes, 4].
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    The standard forward pass requires sequence information as input
</span></span></span><span class="line"><span class="cl"><span class="s1">    and should be used for training or evaluating likelihood.
</span></span></span><span class="line"><span class="cl"><span class="s1">    For sampling or design, use `self.sample`.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): node dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_h_dim (tuple): node dimensions to use in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): edge dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        edge_h_dim (tuple): edge dimensions to embed in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        num_layers (int): number of GVP-GNN layers in encoder/decoder
</span></span></span><span class="line"><span class="cl"><span class="s1">        drop_rate (float): rate to use in all dropout layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        out_dim (int): output dimension (4 bases)
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">node_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">drop_rate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">out_dim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span> <span class="o">=</span> <span class="n">node_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span> <span class="o">=</span> <span class="n">node_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span> <span class="o">=</span> <span class="n">edge_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span> <span class="o">=</span> <span class="n">edge_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span> <span class="o">=</span> <span class="n">out_dim</span>
</span></span><span class="line"><span class="cl">        <span class="n">activations</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">silu</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Node input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Edge input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Encoder layers (supports multiple conformations)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">MultiGVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Simple self-attention on pooled scalar node features</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">embed_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Output</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>   
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Pool multi-conformation features: </span>
</span></span><span class="line"><span class="cl">        <span class="c1"># nodes: (n_nodes, d_s), (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># h_V, h_E = self.pool_multi_conf(h_V, h_E, batch.mask_confs, edge_index)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply simple self-attention over nodes (sequence length = n_nodes)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">need_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">attn_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, out_dim)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logits</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">return_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Pool multi-conformation features</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># h_V, h_E = self.pool_multi_conf(h_V, h_E, batch.mask_confs, edge_index)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, out_dim)</span>
</span></span><span class="line"><span class="cl">            <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_samples)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">return_logits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">logits</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">pool_multi_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Number of conformations is 1, no need to pool</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># True num_conf for masked mean pooling</span>
</span></span><span class="line"><span class="cl">        <span class="n">n_conf_true</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (n_nodes, 1)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask scalar features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V0</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E0</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask vector features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V1</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E1</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Average pooling multi-conformation features</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">,</span>               <span class="c1"># (n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_V1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_E0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>               <span class="c1"># (n_edges, d_se)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_E1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>而由于本地服务器一般很难登上wandb，而作者原版代码在路径上用了很多相关的，因而在<code>trainer.py</code>更改路径，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;xpu&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">intel_extension_for_pytorch</span> <span class="k">as</span> <span class="nn">ipex</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">ipex</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#=======上面的和作者的一样=======</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Initialise save directory</span>
</span></span><span class="line"><span class="cl">    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&#34;..&#34;</span><span class="p">,</span> <span class="s2">&#34;mymodel&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#save_dir = os.path.abspath(save_dir) 这是换成绝对路径，可以不需要；模型保存在主项目目录的mymodel文件夹。  </span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后把<code>wandb.run.dir</code>路径改为<code>save_dir</code>路径，防止训练模型后没有文件；模型默认选择autoaggresive。</p>
<p><strong>注意，训练模型最好挂在后台运行</strong>，具体命令如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">nohup python main.py --no_wandb &gt; main.log 2&gt;&amp;1 &amp;
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后可以查看log日志，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">tail -f main.log
</span></span></code></pre></td></tr></table>
</div>
</div><p>以及及时选择查看gpu的运行情况，例如，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">nvidia-smi
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="第一次测试训练的模型">第一次测试训练的模型
</h3><p>模型以<code>best_checkpoint.h5</code>形式得出，然后根据作者的<code>gRNAde.py</code>脚本，只需修改以下的加载路径和其他没啥用的print字符串就可以，由于多态生成我没有用，因此我没替换那个；其余俩都得替换。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">CHECKPOINT_PATH</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;mymodel/best_checkpoint.h5&#34;</span><span class="p">),</span><span class="c1">#修改为mymodel里的checkpoint</span>
</span></span><span class="line"><span class="cl">        <span class="mi">2</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_2state_all.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">3</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_3state_all.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">5</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_5state_all.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;das&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;mymodel/best_checkpoint.h5&#34;</span><span class="p">),</span><span class="c1">#修改为mymodel里的checkpoint</span>
</span></span><span class="line"><span class="cl">        <span class="mi">2</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_2state_das.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">3</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_3state_das.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">5</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_5state_das.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;multi&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_1state_multi.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">2</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_2state_multi.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">3</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_3state_multi.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="mi">5</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;checkpoints/gRNAde_ARv1_5state_multi.h5&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>除此之外，通过命令行人工测试太费劲了，需要写一个自动化脚本。具体逻辑就是，我在<code>data/raw</code>里面取一些名称作为索引，保存在<code>.txt</code>文件中；然后用脚本把原先命令行的命令包含进去，input文件路径下改为按索引名称.pdb递增，输出.fasta文件同理，<strong>注意models.py文件要保持同步</strong>！！！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#这是自动化测试脚本</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_test_index</span><span class="p">(</span><span class="n">index_file</span><span class="o">=</span><span class="s2">&#34;test.txt&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Read test_index.txt file to get the list of PDB files
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">index_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Filter out empty lines and comment lines, remove newline characters</span>
</span></span><span class="line"><span class="cl">        <span class="n">pdb_files</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">pdb_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pdb_files</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error: File </span><span class="si">{</span><span class="n">index_file</span><span class="si">}</span><span class="s2"> not found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error reading file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_filename_without_extension</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Extract the filename without extension from a PDB filename
</span></span></span><span class="line"><span class="cl"><span class="s2">    Example: 100D_1_A-B.pdb -&gt; 100D_1_A-B
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">pdb_filename</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Execute the run.py command for the specified PDB file
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Extract filename (without extension) for output filename</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_name</span> <span class="o">=</span> <span class="n">extract_filename_without_extension</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Build command</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;python&#34;</span><span class="p">,</span> <span class="s2">&#34;run.py&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--pdb_filepath&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;data/raw/</span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--output_filepath&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;testmyrna/</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">.fasta&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--split&#34;</span><span class="p">,</span> <span class="s2">&#34;das&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--max_num_conformers&#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--n_samples&#34;</span><span class="p">,</span> <span class="s2">&#34;16&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;--temperature&#34;</span><span class="p">,</span> <span class="s2">&#34;0.5&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Processing: </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Executing command: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Execute command</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;✓ Successfully processed </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Output file: testmyrna/</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">.fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Display part of the output if available</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Standard output:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&#34;...&#34;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;✗ Failed to process </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error code: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error message: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;✗ Unexpected error occurred while processing </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Main function
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=== RNA Test Script Started ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Check for required files and directories</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&#34;run.py&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Error: run.py file not found in the current directory&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&#34;test.txt&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Error: test.txt file not found in the current directory&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Ensure output directory exists</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_dir</span> <span class="o">=</span> <span class="s2">&#34;testmyrna&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Read test index file</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdb_files</span> <span class="o">=</span> <span class="n">read_test_index</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">pdb_files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Warning: test.txt file is empty or failed to read&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pdb_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> PDB files to process:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pdb_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pdb_files</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Starting processing...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Statistics</span>
</span></span><span class="line"><span class="cl">    <span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">failed_files</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Process each PDB file</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pdb_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pdb_files</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pdb_files</span><span class="p">)</span><span class="si">}</span><span class="s2">] &#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Check if input file exists</span>
</span></span><span class="line"><span class="cl">        <span class="n">input_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;data/raw/</span><span class="si">{</span><span class="n">pdb_file</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Warning: Input file </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2"> does not exist, skipping...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Execute command</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">run_command</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">failed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdb_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Print summary</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=== Processing Completed ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pdb_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Success: </span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="s2"> files&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Failed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">failed_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">failed_files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Failed files:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">failed_file</span> <span class="ow">in</span> <span class="n">failed_files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  - </span><span class="si">{</span><span class="n">failed_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Output files saved in: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，有时<code>sec_struct_utils.py</code>文件清除缓存速度太快了，所以我进行修改，首先把这部分清除的注释了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Delete temporary files这三行注释掉</span>
</span></span><span class="line"><span class="cl">   <span class="c1"># if sequence is not None:</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#     os.remove(fasta_file_path)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后把路径改了，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="n">current_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fasta_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;temp_</span><span class="si">{</span><span class="n">current_datetime</span><span class="si">}</span><span class="s2">.fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">fasta_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_PATH</span><span class="p">,</span> <span class="s2">&#34;temp&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;temp_</span><span class="si">{</span><span class="n">current_datetime</span><span class="si">}</span><span class="s2">.fasta&#34;</span><span class="p">)</span><span class="c1">#改这里路径后是这样，我一般不用wandb</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成在某文件夹后，需要用新的脚本处理数据，由于我的sample为16，因而需要分别计算length, perplexity, recovery, edit distance, SC Score的平均值，并按照列的顺序保存为.txt文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">glob</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_fasta_file</span><span class="p">(</span><span class="n">fasta_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Parse a single FASTA file to extract the input sequence length and metrics for 16 samples
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">    - input_length: Length of the input sequence
</span></span></span><span class="line"><span class="cl"><span class="s2">    - avg_metrics: Average metrics for 16 samples {perplexity, recovery, edit_dist, sc_score}
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fasta_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Split different sequence blocks</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequences</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">seq</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">sequences</span> <span class="k">if</span> <span class="n">seq</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">input_length</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">sample_metrics</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">seq_block</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span> <span class="o">=</span> <span class="n">seq_block</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">header</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">sequence_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Process input sequence</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;input_sequence&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Combine all sequence lines and calculate length</span>
</span></span><span class="line"><span class="cl">                <span class="n">sequence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sequence_lines</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">input_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  Input sequence length: </span><span class="si">{</span><span class="n">input_length</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Process sample sequence</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;sample=&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Extract metrics using regular expressions</span>
</span></span><span class="line"><span class="cl">                <span class="n">perplexity_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;perplexity=([0-9.]+)&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">recovery_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;recovery=([0-9.]+)&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">edit_dist_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;edit_dist=([0-9.]+)&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sc_score_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;sc_score=([0-9.]+)&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">perplexity_match</span><span class="p">,</span> <span class="n">recovery_match</span><span class="p">,</span> <span class="n">edit_dist_match</span><span class="p">,</span> <span class="n">sc_score_match</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;perplexity&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">perplexity_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;recovery&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">recovery_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;edit_dist&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">edit_dist_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                        <span class="s1">&#39;sc_score&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">sc_score_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sample_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculate averages</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">sample_metrics</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">avg_metrics</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;perplexity&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;perplexity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sample_metrics</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_metrics</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;recovery&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;recovery&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sample_metrics</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_metrics</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;edit_dist&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;edit_dist&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sample_metrics</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_metrics</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;sc_score&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;sc_score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sample_metrics</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_metrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_metrics</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  Average metrics: perplexity=</span><span class="si">{</span><span class="n">avg_metrics</span><span class="p">[</span><span class="s1">&#39;perplexity&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, recovery=</span><span class="si">{</span><span class="n">avg_metrics</span><span class="p">[</span><span class="s1">&#39;recovery&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, edit_dist=</span><span class="si">{</span><span class="n">avg_metrics</span><span class="p">[</span><span class="s1">&#39;edit_dist&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, sc_score=</span><span class="si">{</span><span class="n">avg_metrics</span><span class="p">[</span><span class="s1">&#39;sc_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;  Warning: No valid sample metrics found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">avg_metrics</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">input_length</span><span class="p">,</span> <span class="n">avg_metrics</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  Error: Exception occurred while processing file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_all_fasta_files</span><span class="p">(</span><span class="n">input_dir</span><span class="o">=</span><span class="s2">&#34;tout&#34;</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&#34;data/plotdata/plot.txt&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Process all FASTA files in the specified directory
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=== FASTA File Processing Script ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Check input directory</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error: Input directory does not exist: </span><span class="si">{</span><span class="n">input_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create output directory</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Find all FASTA files</span>
</span></span><span class="line"><span class="cl">    <span class="n">fasta_pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="s2">&#34;*.fasta&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">fasta_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fasta_pattern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">fasta_files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Warning: No .fasta files found in </span><span class="si">{</span><span class="n">input_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fasta_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> FASTA files&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Store processing results</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">processed_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">failed_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Process each FASTA file</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fasta_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">fasta_files</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fasta_files</span><span class="p">)</span><span class="si">}</span><span class="s2">] Processing file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">input_length</span><span class="p">,</span> <span class="n">avg_metrics</span> <span class="o">=</span> <span class="n">parse_fasta_file</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">input_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">avg_metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Format result</span>
</span></span><span class="line"><span class="cl">            <span class="n">result_line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">input_length</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">avg_metrics</span><span class="p">[</span><span class="s1">&#39;perplexity&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">avg_metrics</span><span class="p">[</span><span class="s1">&#39;recovery&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">avg_metrics</span><span class="p">[</span><span class="s1">&#39;edit_dist&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">avg_metrics</span><span class="p">[</span><span class="s1">&#39;sc_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">processed_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  ✓ Processed successfully&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  ✗ Processing failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">failed_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Save results</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">=== Processing Completed ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Total files: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fasta_files</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Successfully processed: </span><span class="si">{</span><span class="n">processed_count</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Failed: </span><span class="si">{</span><span class="n">failed_count</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Results saved to: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Show preview of first few lines</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Results preview (first 5 lines):&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span><span class="mi">5</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;  ... (total </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> lines)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error saving file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No successfully processed data, unable to generate output file&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">validate_output_format</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Validate the format of the output file
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Output file does not exist&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">=== Validate Output Format ===&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Total lines: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Check first 3 lines</span>
</span></span><span class="line"><span class="cl">            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">perplexity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">recovery</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">edit_dist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">sc_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Line </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: length=</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">, perplexity=</span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s2">, recovery=</span><span class="si">{</span><span class="n">recovery</span><span class="si">}</span><span class="s2">, edit_dist=</span><span class="si">{</span><span class="n">edit_dist</span><span class="si">}</span><span class="s2">, sc_score=</span><span class="si">{</span><span class="n">sc_score</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Line </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> format error: </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error during validation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Main function
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Set input and output paths</span>
</span></span><span class="line"><span class="cl">    <span class="n">input_directory</span> <span class="o">=</span> <span class="s2">&#34;tout&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_filepath</span> <span class="o">=</span> <span class="s2">&#34;data/plotdata/plotgrna.txt&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Process all FASTA files</span>
</span></span><span class="line"><span class="cl">    <span class="n">process_all_fasta_files</span><span class="p">(</span><span class="n">input_directory</span><span class="p">,</span> <span class="n">output_filepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Validate output format</span>
</span></span><span class="line"><span class="cl">    <span class="n">validate_output_format</span><span class="p">(</span><span class="n">output_filepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以及matlab的绘图代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-matlab" data-lang="matlab"><span class="line"><span class="cl"><span class="c">% Script to visualize RNA prediction metrics from else.txt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">% Load data</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="p">=</span> <span class="n">load</span><span class="p">(</span><span class="s">&#39;g.txt&#39;</span><span class="p">);</span> <span class="c">% Format: [length, perplexity, recovery, edit_dist, sc_score]</span>
</span></span><span class="line"><span class="cl"><span class="n">lengths</span> <span class="p">=</span> <span class="n">data</span><span class="p">(:,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">perplexity</span> <span class="p">=</span> <span class="n">data</span><span class="p">(:,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">recovery</span> <span class="p">=</span> <span class="n">data</span><span class="p">(:,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_dist</span> <span class="p">=</span> <span class="n">data</span><span class="p">(:,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">sc_score</span> <span class="p">=</span> <span class="n">data</span><span class="p">(:,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">% Compute unique lengths and their average metrics</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">unique_lengths</span><span class="p">,</span> <span class="o">~</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="p">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">lengths</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">unique_lengths</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_perplexity</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_recovery</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_edit_dist</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_sc_score</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">n</span>
</span></span><span class="line"><span class="cl">    <span class="n">avg_perplexity</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">perplexity</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="nb">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">avg_recovery</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">recovery</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="nb">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">avg_edit_dist</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">edit_dist</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="nb">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">avg_sc_score</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">sc_score</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="nb">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">% Prepare 2x2 subplot</span>
</span></span><span class="line"><span class="cl"><span class="n">figure</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;RNA Prediction Metrics&#39;</span><span class="p">,</span><span class="s">&#39;NumberTitle&#39;</span><span class="p">,</span><span class="s">&#39;off&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">metrics</span> <span class="p">=</span> <span class="p">{</span><span class="n">avg_perplexity</span><span class="p">,</span> <span class="n">avg_recovery</span><span class="p">,</span> <span class="n">avg_edit_dist</span><span class="p">,</span> <span class="n">avg_sc_score</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">titles</span> <span class="p">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#39;Variation of Perplexity with RNA Sequence Length&#39;</span><span class="p">,</span> <span class="c">...</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#39;Variation of Recovery Rate with RNA Sequence Length&#39;</span><span class="p">,</span> <span class="c">...</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#39;Variation of Edit Distance with RNA Sequence Length&#39;</span><span class="p">,</span> <span class="c">...</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#39;Variation of Structural Conservation Score with RNA Sequence Length&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">ylabels</span> <span class="p">=</span> <span class="p">{</span><span class="s">&#39;Average Perplexity&#39;</span><span class="p">,</span> <span class="s">&#39;Average Recovery Rate&#39;</span><span class="p">,</span> <span class="c">...</span>
</span></span><span class="line"><span class="cl">           <span class="s">&#39;Average Edit Distance&#39;</span><span class="p">,</span> <span class="s">&#39;Average SC Score&#39;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">% Set Times New Roman font for all text</span>
</span></span><span class="line"><span class="cl"><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;defaultAxesFontName&#39;</span><span class="p">,</span><span class="s">&#39;Times New Roman&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;defaultTextFontName&#39;</span><span class="p">,</span><span class="s">&#39;Times New Roman&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">markerSize</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>      
</span></span><span class="line"><span class="cl"><span class="n">markerColor</span> <span class="p">=</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">];</span> 
</span></span><span class="line"><span class="cl"><span class="n">lineWidth</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>     
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="nb">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">scatter</span><span class="p">(</span><span class="n">unique_lengths</span><span class="p">,</span> <span class="n">metrics</span><span class="p">{</span><span class="nb">i</span><span class="p">},</span> <span class="n">markerSize</span><span class="p">,</span> <span class="c">...</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#39;MarkerEdgeColor&#39;</span><span class="p">,</span> <span class="n">markerColor</span><span class="p">,</span> <span class="c">...</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#39;MarkerFaceColor&#39;</span><span class="p">,</span> <span class="n">markerColor</span><span class="p">,</span> <span class="c">...</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#39;LineWidth&#39;</span><span class="p">,</span> <span class="n">lineWidth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;RNA Sequence Length (nt)&#39;</span><span class="p">,</span><span class="s">&#39;FontName&#39;</span><span class="p">,</span><span class="s">&#39;Times New Roman&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ylabel</span><span class="p">(</span><span class="n">ylabels</span><span class="p">{</span><span class="nb">i</span><span class="p">},</span><span class="s">&#39;FontName&#39;</span><span class="p">,</span><span class="s">&#39;Times New Roman&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span><span class="p">(</span><span class="n">titles</span><span class="p">{</span><span class="nb">i</span><span class="p">},</span><span class="s">&#39;FontName&#39;</span><span class="p">,</span><span class="s">&#39;Times New Roman&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">grid</span> <span class="n">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">set</span><span class="p">(</span><span class="n">gca</span><span class="p">,</span><span class="s">&#39;FontName&#39;</span><span class="p">,</span><span class="s">&#39;Times New Roman&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">% Adjust layout</span>
</span></span><span class="line"><span class="cl"><span class="n">sgtitle</span><span class="p">(</span><span class="s">&#39;Comparative Analysis of GRNADE Prediction Metrics&#39;</span><span class="p">,</span><span class="s">&#39;FontName&#39;</span><span class="p">,</span><span class="s">&#39;Times New Roman&#39;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>除此之外，模型models.py如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">################################################################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Generalisation of Geometric Vector Perceptron, Jing et al.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for explicit multi-state biomolecule representation learning.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Original repository: https://github.com/drorlab/gvp-pytorch</span>
</span></span><span class="line"><span class="cl"><span class="c1">################################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">Categorical</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch_geometric</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">src.layers</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AutoregressiveMultiGNNv1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Autoregressive GVP-GNN for **multiple** structure-conditioned RNA design.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    Takes in RNA structure graphs of type `torch_geometric.data.Data` 
</span></span></span><span class="line"><span class="cl"><span class="s1">    or `torch_geometric.data.Batch` and returns a categorical distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">    over 4 bases at each position in a `torch.Tensor` of shape [n_nodes, 4].
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    The standard forward pass requires sequence information as input
</span></span></span><span class="line"><span class="cl"><span class="s1">    and should be used for training or evaluating likelihood.
</span></span></span><span class="line"><span class="cl"><span class="s1">    For sampling or design, use `self.sample`.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): node dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_h_dim (tuple): node dimensions to use in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): edge dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        edge_h_dim (tuple): edge dimensions to embed in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        num_layers (int): number of GVP-GNN layers in encoder/decoder
</span></span></span><span class="line"><span class="cl"><span class="s1">        drop_rate (float): rate to use in all dropout layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        out_dim (int): output dimension (4 bases)
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">node_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">drop_rate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">out_dim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span> <span class="o">=</span> <span class="n">node_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span> <span class="o">=</span> <span class="n">node_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span> <span class="o">=</span> <span class="n">edge_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span> <span class="o">=</span> <span class="n">edge_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span> <span class="o">=</span> <span class="n">out_dim</span>
</span></span><span class="line"><span class="cl">        <span class="n">activations</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">silu</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Node input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Edge input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Encoder layers (supports multiple conformations)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">MultiGVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Simple self-attention on pooled scalar node features</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">embed_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Decoder layers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">GVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                             <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">autoregressive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Output</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span> <span class="o">=</span> <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">seq</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Pool multi-conformation features: </span>
</span></span><span class="line"><span class="cl">        <span class="c1"># nodes: (n_nodes, d_s), (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_multi_conf</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply simple self-attention over nodes (sequence length = n_nodes)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">need_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">attn_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">encoder_embeddings</span> <span class="o">=</span> <span class="n">h_V</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_s</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span> <span class="o">=</span> <span class="n">h_S</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_S</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">autoregressive_x</span> <span class="o">=</span> <span class="n">encoder_embeddings</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logits</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@torch.no_grad</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">batch</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">n_samples</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">logit_bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">return_logits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        Samples sequences autoregressively from the distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">        learned by the model.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">            batch (torch_geometric.data.Data): mini-batch containing one
</span></span></span><span class="line"><span class="cl"><span class="s1">                RNA backbone to design sequences for
</span></span></span><span class="line"><span class="cl"><span class="s1">            n_samples (int): number of samples
</span></span></span><span class="line"><span class="cl"><span class="s1">            temperature (float): temperature to use in softmax over 
</span></span></span><span class="line"><span class="cl"><span class="s1">                the categorical distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">            logit_bias (torch.Tensor): bias to add to logits during sampling
</span></span></span><span class="line"><span class="cl"><span class="s1">                to manually fix or control nucleotides in designed sequences,
</span></span></span><span class="line"><span class="cl"><span class="s1">                of shape [n_nodes, 4]
</span></span></span><span class="line"><span class="cl"><span class="s1">            return_logits (bool): whether to return logits or not
</span></span></span><span class="line"><span class="cl"><span class="s1">        
</span></span></span><span class="line"><span class="cl"><span class="s1">        Returns:
</span></span></span><span class="line"><span class="cl"><span class="s1">            seq (torch.Tensor): int tensor of shape [n_samples, n_nodes]
</span></span></span><span class="line"><span class="cl"><span class="s1">                                based on the residue-to-int mapping of
</span></span></span><span class="line"><span class="cl"><span class="s1">                                the original training data
</span></span></span><span class="line"><span class="cl"><span class="s1">            logits (torch.Tensor): logits of shape [n_samples, n_nodes, 4]
</span></span></span><span class="line"><span class="cl"><span class="s1">                                   (only if return_logits is True)
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#39;&#39;&#39;</span> 
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="n">device</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">device</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Pool multi-conformation features</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># nodes: (n_nodes, d_s), (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_multi_conf</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply simple self-attention over nodes (sequence length = n_nodes)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">need_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_ln</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">attn_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Repeat features for sampling n_samples times</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Expand edge index for autoregressive decoding</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="n">num_nodes</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">edge_index</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># This is akin to &#39;batching&#39; (in PyG style) n_samples copies of the graph</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V_cache</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Decode one token at a time</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">h_S_</span> <span class="o">=</span> <span class="n">h_S</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_S_</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E_</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_S_</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">            <span class="n">edge_mask</span> <span class="o">=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">num_nodes</span> <span class="o">==</span> <span class="n">i</span>  <span class="c1"># True for all edges where dst is node i</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_index_</span> <span class="o">=</span> <span class="n">edge_index</span><span class="p">[:,</span> <span class="n">edge_mask</span><span class="p">]</span>  <span class="c1"># subset all incoming edges to node i</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E_</span> <span class="o">=</span> <span class="n">tuple_index</span><span class="p">(</span><span class="n">h_E_</span><span class="p">,</span> <span class="n">edge_mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">node_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">node_mask</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># True for all nodes i and its repeats</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V_cache</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">edge_index_</span><span class="p">,</span> <span class="n">h_E_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">autoregressive_x</span><span class="o">=</span><span class="n">h_V_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node_mask</span><span class="o">=</span><span class="n">node_mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="n">tuple_index</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">node_mask</span><span class="p">)</span>  <span class="c1"># subset out to only node i and its repeats</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">h_V_cache</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">h_V_cache</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="n">lgts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Add logit bias if provided to fix or bias positions</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">logit_bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">lgts</span> <span class="o">+=</span> <span class="n">logit_bias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Sample from logits</span>
</span></span><span class="line"><span class="cl">            <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">lgts</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_S</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_s</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">return_logits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">),</span> <span class="n">logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>    
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">pool_multi_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Number of conformations is 1, no need to pool</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># True num_conf for masked mean pooling</span>
</span></span><span class="line"><span class="cl">        <span class="n">n_conf_true</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (n_nodes, 1)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask scalar features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V0</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E0</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask vector features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V1</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E1</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Average pooling multi-conformation features</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">,</span>               <span class="c1"># (n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_V1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_E0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>               <span class="c1"># (n_edges, d_se)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_E1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NonAutoregressiveMultiGNNv1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Non-Autoregressive GVP-GNN for **multiple** structure-conditioned RNA design.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    Takes in RNA structure graphs of type `torch_geometric.data.Data` 
</span></span></span><span class="line"><span class="cl"><span class="s1">    or `torch_geometric.data.Batch` and returns a categorical distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">    over 4 bases at each position in a `torch.Tensor` of shape [n_nodes, 4].
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    The standard forward pass requires sequence information as input
</span></span></span><span class="line"><span class="cl"><span class="s1">    and should be used for training or evaluating likelihood.
</span></span></span><span class="line"><span class="cl"><span class="s1">    For sampling or design, use `self.sample`.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): node dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_h_dim (tuple): node dimensions to use in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): edge dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        edge_h_dim (tuple): edge dimensions to embed in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        num_layers (int): number of GVP-GNN layers in encoder/decoder
</span></span></span><span class="line"><span class="cl"><span class="s1">        drop_rate (float): rate to use in all dropout layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        out_dim (int): output dimension (4 bases)
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">node_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">drop_rate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">out_dim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span> <span class="o">=</span> <span class="n">node_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span> <span class="o">=</span> <span class="n">node_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span> <span class="o">=</span> <span class="n">edge_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span> <span class="o">=</span> <span class="n">edge_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span> <span class="o">=</span> <span class="n">out_dim</span>
</span></span><span class="line"><span class="cl">        <span class="n">activations</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">silu</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Node input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Edge input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Encoder layers (supports multiple conformations)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">MultiGVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Output</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>   
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Pool multi-conformation features: </span>
</span></span><span class="line"><span class="cl">        <span class="c1"># nodes: (n_nodes, d_s), (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># h_V, h_E = self.pool_multi_conf(h_V, h_E, batch.mask_confs, edge_index)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, out_dim)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logits</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">return_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Pool multi-conformation features</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># h_V, h_E = self.pool_multi_conf(h_V, h_E, batch.mask_confs, edge_index)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, out_dim)</span>
</span></span><span class="line"><span class="cl">            <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_samples)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">return_logits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">logits</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">pool_multi_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Number of conformations is 1, no need to pool</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># True num_conf for masked mean pooling</span>
</span></span><span class="line"><span class="cl">        <span class="n">n_conf_true</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (n_nodes, 1)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask scalar features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V0</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E0</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask vector features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V1</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E1</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Average pooling multi-conformation features</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">,</span>               <span class="c1"># (n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_V1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_E0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>               <span class="c1"># (n_edges, d_se)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_E1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>经过实验与对比，起初的问题是，当<code>epoch = 1</code>的时候，模型简直非常差：</p>
<div align=center><img src="11.png" width=600/></div>
<center><font size=2>很差的效果</font></center>
<p>但是当epoch提升到50，肉眼可见的好多了，和作者训练的模型几乎一致，因此代码是没问题的：</p>
<div align=center><img src="12.png" width=600/></div>
<center><font size=2>epoch=50的效果</font></center>
<p>然而在我训练后发现我加了attention的模型与不加一模一样，后来发现，我在nonaggressive里面加的，而模型默认没选择这个。</p>
<div align=center><img src="13.png" width=370/><img src="14.png" width=400/></div>
<center><font size=2>效果几乎一模一样，很奇怪</font></center>
<p>在之后，我重新修改了multiheadattention代码，训练好模型后如下，进行预测</p>
<div align=center><img src="15.png" width=200/></div>
<center><font size=2>我的模型</font></center>
<div align=center><img src="16.png" width=600/></div>
<center><font size=2>使用情况正常</font></center>
<p>我随机抽取了500个datapoint后进行测试，保持全部的一致，控制变量，结果如图：</p>
<div align=center><img src="mygrnade.png" width=600/><img src="mymultihead.png" width=600/></div>
<center><font size=2>实际情况看来，貌似有效果但不大</font></center>
<p>因此我在考虑multi-scale attention的想法，根据论文<strong>Atlas: Multi-Scale Attention Improves Long Context Image Modeling</strong>的思路与AI的协助（实际上压力ai了），现在模型是如下这样，训练之后在进行测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">################################################################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Generalisation of Geometric Vector Perceptron, Jing et al.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for explicit multi-state biomolecule representation learning.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Original repository: https://github.com/drorlab/gvp-pytorch</span>
</span></span><span class="line"><span class="cl"><span class="c1">################################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">Categorical</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch_geometric</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">src.layers</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MultiScaleAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Multi-scale attention module to capture dependencies at different window sizes.
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">embed_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">window_sizes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>  <span class="c1"># None for global scale</span>
</span></span><span class="line"><span class="cl">        <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">window_sizes</span> <span class="o">=</span> <span class="n">window_sizes</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">attentions</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">            <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">embed_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">window_sizes</span>
</span></span><span class="line"><span class="cl">        <span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># x: (batch_size, seq_len, embed_dim)</span>
</span></span><span class="line"><span class="cl">        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">attn</span><span class="p">,</span> <span class="n">window_size</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attentions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_sizes</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">window_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Global attention</span>
</span></span><span class="line"><span class="cl">                <span class="n">attn_output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">attn_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Local window attention: create sliding window mask or approximate</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># For simplicity, we can use full attention but in practice, implement windowing</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Here, as a placeholder, apply full attention per scale (can be optimized with sparse masks)</span>
</span></span><span class="line"><span class="cl">                <span class="n">attn_output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">attn_mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attn_output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Fuse outputs: average across scales</span>
</span></span><span class="line"><span class="cl">        <span class="n">fused_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">outputs</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">fused_output</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AutoregressiveMultiGNNv1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Autoregressive GVP-GNN for **multiple** structure-conditioned RNA design.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    Takes in RNA structure graphs of type `torch_geometric.data.Data` 
</span></span></span><span class="line"><span class="cl"><span class="s1">    or `torch_geometric.data.Batch` and returns a categorical distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">    over 4 bases at each position in a `torch.Tensor` of shape [n_nodes, 4].
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    The standard forward pass requires sequence information as input
</span></span></span><span class="line"><span class="cl"><span class="s1">    and should be used for training or evaluating likelihood.
</span></span></span><span class="line"><span class="cl"><span class="s1">    For sampling or design, use `self.sample`.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): node dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_h_dim (tuple): node dimensions to use in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): edge dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        edge_h_dim (tuple): edge dimensions to embed in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        num_layers (int): number of GVP-GNN layers in encoder/decoder
</span></span></span><span class="line"><span class="cl"><span class="s1">        drop_rate (float): rate to use in all dropout layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        out_dim (int): output dimension (4 bases)
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">node_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">drop_rate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">out_dim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_attention_heads</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">attention_window_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>  <span class="c1"># Multi-scale windows</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span> <span class="o">=</span> <span class="n">node_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span> <span class="o">=</span> <span class="n">node_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span> <span class="o">=</span> <span class="n">edge_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span> <span class="o">=</span> <span class="n">edge_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span> <span class="o">=</span> <span class="n">out_dim</span>
</span></span><span class="line"><span class="cl">        <span class="n">activations</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">silu</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Node input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Edge input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Encoder layers (supports multiple conformations)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">MultiGVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Multi-scale attention for capturing long-distance dependencies at different scales</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">multi_scale_attention</span> <span class="o">=</span> <span class="n">MultiScaleAttention</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">embed_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># Scalar dimension</span>
</span></span><span class="line"><span class="cl">            <span class="n">num_heads</span><span class="o">=</span><span class="n">num_attention_heads</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">window_sizes</span><span class="o">=</span><span class="n">attention_window_sizes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">dropout</span><span class="o">=</span><span class="n">drop_rate</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Decoder layers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">GVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                             <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">autoregressive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Output</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span> <span class="o">=</span> <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">seq</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Pool multi-conformation features: </span>
</span></span><span class="line"><span class="cl">        <span class="c1"># nodes: (n_nodes, d_s), (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_multi_conf</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply multi-scale attention on pooled scalar features</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V_s</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_scale_attention</span><span class="p">(</span><span class="n">h_V_s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">attn_output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Residual connection</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">encoder_embeddings</span> <span class="o">=</span> <span class="n">h_V</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_s</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span> <span class="o">=</span> <span class="n">h_S</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_S</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">autoregressive_x</span> <span class="o">=</span> <span class="n">encoder_embeddings</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logits</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@torch.no_grad</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">batch</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">n_samples</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">logit_bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">return_logits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        Samples sequences autoregressively from the distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">        learned by the model.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">            batch (torch_geometric.data.Data): mini-batch containing one
</span></span></span><span class="line"><span class="cl"><span class="s1">                RNA backbone to design sequences for
</span></span></span><span class="line"><span class="cl"><span class="s1">            n_samples (int): number of samples
</span></span></span><span class="line"><span class="cl"><span class="s1">            temperature (float): temperature to use in softmax over 
</span></span></span><span class="line"><span class="cl"><span class="s1">                the categorical distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">            logit_bias (torch.Tensor): bias to add to logits during sampling
</span></span></span><span class="line"><span class="cl"><span class="s1">                to manually fix or control nucleotides in designed sequences,
</span></span></span><span class="line"><span class="cl"><span class="s1">                of shape [n_nodes, 4]
</span></span></span><span class="line"><span class="cl"><span class="s1">            return_logits (bool): whether to return logits or not
</span></span></span><span class="line"><span class="cl"><span class="s1">        
</span></span></span><span class="line"><span class="cl"><span class="s1">        Returns:
</span></span></span><span class="line"><span class="cl"><span class="s1">            seq (torch.Tensor): int tensor of shape [n_samples, n_nodes]
</span></span></span><span class="line"><span class="cl"><span class="s1">                                based on the residue-to-int mapping of
</span></span></span><span class="line"><span class="cl"><span class="s1">                                the original training data
</span></span></span><span class="line"><span class="cl"><span class="s1">            logits (torch.Tensor): logits of shape [n_samples, n_nodes, 4]
</span></span></span><span class="line"><span class="cl"><span class="s1">                                   (only if return_logits is True)
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#39;&#39;&#39;</span> 
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="n">device</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">device</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Pool multi-conformation features</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># nodes: (n_nodes, d_s), (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_multi_conf</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Apply multi-scale attention on pooled scalar features</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V_s</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">        <span class="n">attn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_scale_attention</span><span class="p">(</span><span class="n">h_V_s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">attn_output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Residual connection</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Repeat features for sampling n_samples times</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Expand edge index for autoregressive decoding</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="n">num_nodes</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">edge_index</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># This is akin to &#39;batching&#39; (in PyG style) n_samples copies of the graph</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_S</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V_cache</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Decode one token at a time</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">h_S_</span> <span class="o">=</span> <span class="n">h_S</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_S_</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E_</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_S_</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">            <span class="n">edge_mask</span> <span class="o">=</span> <span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">num_nodes</span> <span class="o">==</span> <span class="n">i</span>  <span class="c1"># True for all edges where dst is node i</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_index_</span> <span class="o">=</span> <span class="n">edge_index</span><span class="p">[:,</span> <span class="n">edge_mask</span><span class="p">]</span>  <span class="c1"># subset all incoming edges to node i</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E_</span> <span class="o">=</span> <span class="n">tuple_index</span><span class="p">(</span><span class="n">h_E_</span><span class="p">,</span> <span class="n">edge_mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">node_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">node_mask</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># True for all nodes i and its repeats</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V_cache</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">edge_index_</span><span class="p">,</span> <span class="n">h_E_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">autoregressive_x</span><span class="o">=</span><span class="n">h_V_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node_mask</span><span class="o">=</span><span class="n">node_mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="n">tuple_index</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">node_mask</span><span class="p">)</span>  <span class="c1"># subset out to only node i and its repeats</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder_layers</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">h_V_cache</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">h_V_cache</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="n">lgts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Add logit bias if provided to fix or bias positions</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">logit_bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">lgts</span> <span class="o">+=</span> <span class="n">logit_bias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Sample from logits</span>
</span></span><span class="line"><span class="cl">            <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">lgts</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_S</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_s</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">num_nodes</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">return_logits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">),</span> <span class="n">logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>    
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">num_nodes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">pool_multi_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Number of conformations is 1, no need to pool</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># True num_conf for masked mean pooling</span>
</span></span><span class="line"><span class="cl">        <span class="n">n_conf_true</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (n_nodes, 1)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask scalar features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V0</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E0</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask vector features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V1</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E1</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Average pooling multi-conformation features</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">,</span>               <span class="c1"># (n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_V1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_E0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>               <span class="c1"># (n_edges, d_se)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_E1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">NonAutoregressiveMultiGNNv1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    Non-Autoregressive GVP-GNN for **multiple** structure-conditioned RNA design.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    Takes in RNA structure graphs of type `torch_geometric.data.Data` 
</span></span></span><span class="line"><span class="cl"><span class="s1">    or `torch_geometric.data.Batch` and returns a categorical distribution
</span></span></span><span class="line"><span class="cl"><span class="s1">    over 4 bases at each position in a `torch.Tensor` of shape [n_nodes, 4].
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    The standard forward pass requires sequence information as input
</span></span></span><span class="line"><span class="cl"><span class="s1">    and should be used for training or evaluating likelihood.
</span></span></span><span class="line"><span class="cl"><span class="s1">    For sampling or design, use `self.sample`.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): node dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_h_dim (tuple): node dimensions to use in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        node_in_dim (tuple): edge dimensions in input graph
</span></span></span><span class="line"><span class="cl"><span class="s1">        edge_h_dim (tuple): edge dimensions to embed in GVP-GNN layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        num_layers (int): number of GVP-GNN layers in encoder/decoder
</span></span></span><span class="line"><span class="cl"><span class="s1">        drop_rate (float): rate to use in all dropout layers
</span></span></span><span class="line"><span class="cl"><span class="s1">        out_dim (int): output dimension (4 bases)
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">node_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_in_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">        <span class="n">edge_h_dim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">num_layers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">drop_rate</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">out_dim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span> <span class="o">=</span> <span class="n">node_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span> <span class="o">=</span> <span class="n">node_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span> <span class="o">=</span> <span class="n">edge_in_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span> <span class="o">=</span> <span class="n">edge_h_dim</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span> <span class="o">=</span> <span class="n">out_dim</span>
</span></span><span class="line"><span class="cl">        <span class="n">activations</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">silu</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Node input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Edge input embedding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_in_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Encoder layers (supports multiple conformations)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">MultiGVPConvLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_h_dim</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                  <span class="n">activations</span><span class="o">=</span><span class="n">activations</span><span class="p">,</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">drop_rate</span><span class="o">=</span><span class="n">drop_rate</span><span class="p">,</span> <span class="n">norm_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Output</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">vector_gate</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">GVP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_h_dim</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                <span class="n">activations</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>   
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Pool multi-conformation features: </span>
</span></span><span class="line"><span class="cl">        <span class="c1"># nodes: (n_nodes, d_s), (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># edges: (n_edges, d_se), (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># h_V, h_E = self.pool_multi_conf(h_V, h_E, batch.mask_confs, edge_index)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, out_dim)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logits</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">return_logits</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">node_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_s</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">edge_index</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_v</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_e</span><span class="p">(</span><span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_edges, n_conf, d_se), (n_edges, n_conf, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">h_V</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">h_V</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">h_E</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, d_s), (n_nodes, n_conf, d_v, 3)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Pool multi-conformation features</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># h_V, h_E = self.pool_multi_conf(h_V, h_E, batch.mask_confs, edge_index)</span>
</span></span><span class="line"><span class="cl">            <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_out</span><span class="p">(</span><span class="n">h_V</span><span class="p">)</span>  <span class="c1"># (n_nodes, out_dim)</span>
</span></span><span class="line"><span class="cl">            <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_samples)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">return_logits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">logits</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">seq</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">pool_multi_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span><span class="p">,</span> <span class="n">mask_confs</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Number of conformations is 1, no need to pool</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># True num_conf for masked mean pooling</span>
</span></span><span class="line"><span class="cl">        <span class="n">n_conf_true</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (n_nodes, 1)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask scalar features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_confs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V0</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E0</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Mask vector features</span>
</span></span><span class="line"><span class="cl">        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (n_nodes, n_conf, 1, 1)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V1</span> <span class="o">=</span> <span class="n">h_V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E1</span> <span class="o">=</span> <span class="n">h_E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># Average pooling multi-conformation features</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_V</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_V0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">,</span>               <span class="c1"># (n_nodes, d_s)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_V1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_nodes, d_v, 3)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_E</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_E0</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>               <span class="c1"># (n_edges, d_se)</span>
</span></span><span class="line"><span class="cl">               <span class="n">h_E1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_conf_true</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># (n_edges, d_ve, 3)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">h_V</span><span class="p">,</span> <span class="n">h_E</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据新的模型训练后进行测试比对，</p>
<div align=center><img src="multiscale.png" width=600/></div>
<center><font size=2>Multi-Scale Attention</font></center>
<p>看起来有点作用不是吗？</p>
<h3 id="测试multi-scale在数据集的效果">测试Multi-scale在数据集的效果
</h3><p>在同样500条数据集测试，grnade模型的数据如下：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Length Range</th>
          <th>Statistic</th>
          <th>Perplexity</th>
          <th>Recovery</th>
          <th>Edit Distance</th>
          <th>SC Score</th>
          <th>Sample Count</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0-100</td>
          <td>Median</td>
          <td>1.4128</td>
          <td>0.56445</td>
          <td>17.5972</td>
          <td>0.62315</td>
          <td>234</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Median</td>
          <td>1.26885</td>
          <td>0.73585</td>
          <td>30.2634</td>
          <td>0.61495</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Median</td>
          <td>1.3132</td>
          <td>0.64605</td>
          <td>226.875</td>
          <td>0.42835</td>
          <td>138</td>
      </tr>
      <tr>
          <td>0-100</td>
          <td>Mean</td>
          <td>1.47854274</td>
          <td>0.569795726</td>
          <td>18.55480427</td>
          <td>0.634651282</td>
          <td>234</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Mean</td>
          <td>1.34514583</td>
          <td>0.685369444</td>
          <td>37.49759306</td>
          <td>0.569984722</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Mean</td>
          <td>1.41243696</td>
          <td>0.639286232</td>
          <td>211.1403986</td>
          <td>0.421031884</td>
          <td>138</td>
      </tr>
  </tbody>
</table></div>
<p>而加了multiheadattention后数据如表格：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Length Range</th>
          <th>Statistic</th>
          <th>Perplexity</th>
          <th>Recovery</th>
          <th>Edit Distance</th>
          <th>SC Score</th>
          <th>Sample Count</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0-100</td>
          <td>Median</td>
          <td>1.30675</td>
          <td>0.5532</td>
          <td>17.21875</td>
          <td>0.62105</td>
          <td>234</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Median</td>
          <td>1.17275</td>
          <td>0.7444</td>
          <td>29.75</td>
          <td>0.62205</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Median</td>
          <td>1.30785</td>
          <td>0.70485</td>
          <td>183.84375</td>
          <td>0.41915</td>
          <td>140</td>
      </tr>
      <tr>
          <td>0-100</td>
          <td>Mean</td>
          <td>1.36121325</td>
          <td>0.572758974</td>
          <td>18.34507564</td>
          <td>0.638930342</td>
          <td>234</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Mean</td>
          <td>1.24458056</td>
          <td>0.704726389</td>
          <td>35.62898472</td>
          <td>0.605529167</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Mean</td>
          <td>1.36845071</td>
          <td>0.685876429</td>
          <td>180.6455357</td>
          <td>0.430865714</td>
          <td>140</td>
      </tr>
  </tbody>
</table></div>
<p>之后用的多层注意力Multiscale attention如下：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Length Range</th>
          <th>Statistic</th>
          <th>Perplexity</th>
          <th>Recovery</th>
          <th>Edit Distance</th>
          <th>SC Score</th>
          <th>Sample Count</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0-100</td>
          <td>Median</td>
          <td>1.3358</td>
          <td>0.5592</td>
          <td>17.6667</td>
          <td>0.6396</td>
          <td>235</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Median</td>
          <td>1.2226</td>
          <td>0.71205</td>
          <td>33.78125</td>
          <td>0.6771</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Median</td>
          <td>1.32545</td>
          <td>0.68665</td>
          <td>193.0625</td>
          <td>0.42465</td>
          <td>140</td>
      </tr>
      <tr>
          <td>0-100</td>
          <td>Mean</td>
          <td>1.36930766</td>
          <td>0.557402979</td>
          <td>18.98926</td>
          <td>0.660275319</td>
          <td>235</td>
      </tr>
      <tr>
          <td>100-200</td>
          <td>Mean</td>
          <td>1.28780417</td>
          <td>0.682672222</td>
          <td>37.93399306</td>
          <td>0.624776389</td>
          <td>72</td>
      </tr>
      <tr>
          <td>200+</td>
          <td>Mean</td>
          <td>1.40186786</td>
          <td>0.673555</td>
          <td>187.8361607</td>
          <td>0.434380714</td>
          <td>140</td>
      </tr>
  </tbody>
</table></div>
<p>在多数据测试之后，我做可视化对比，我们主要比较SCC，Recovery。</p>
<div align=center><img src="18.png" width=600/></div>
<center><font size=2>加了注意力的两个模型实际在表现上都比原版好，现在就要取舍了</font></center>
<p>最终我认为SCC指标更重要，因而在12000条数据对multiscale和grnade进行测试，得到二者lgx为坐标的图像对比：</p>
<div align=center><img src="grlong.png" width=500/><img src="multilong.png" width=500/></div>
<center><font size=2>是有细微差别的，毕竟grnade已经算sota了，优化起来费劲</font></center>
<div align=center><img src="17.png" width=600/></div>
<center><font size=2>经过对比，在中长序列显著提高了SCC，同时平均Recovery差别不大</font></center>
<h4 id="但是数据泄露的问题来了">但是数据泄露的问题来了
</h4><p>作者有13000+数据（2023年RNAsolo），能用的大概12000+，其中train split有12000+，而500+个validation set，200+在test set。</p>
<p>什么概念？12000：500：200，比8：1：1差远了；这还没完，更离谱的是这200条数据集甚至长度都没超过200的，这让我测试个啥？</p>
<div align=center><img src="picture.png" width=300/></div>
<center><font size=2>0-160的长度范围</font></center>
<p>当然，实验不能白做，我在这个test set上面还是测试了一下两个模型，看起来我们的方法在长序列情况下还是占优势：</p>
<div align=center><img src="picture1.png" width=600/></div>
<center><font size=2>其实不小心把图例打错了，不过问题不大</font></center>
<h3 id="痛定思痛如何优化split方法">痛定思痛：如何优化split方法？
</h3><p>作者把小于10nt、大于1000nt的全丢进去训练集了；再加上划分的不合理，我的想法是，要不先按照0-100，100-200，200+的length range把cluster进行划分？然后在各自范围用8：1：1的方式来筛选cluster，最后把cluster含有的pdb索引拿出来，这样会好一些。</p>
<p><strong>但是这就产生了疑惑：</strong></p>
<p>**为啥不是8:1:1直接划分不同长度的呢？**其实我也不清楚，我和gemini讨论之后发现，作者划分cluster是按照rna家族的相似性进行划分的，如果直接划分的话容易把同一个cluster的rna划分到一半训练集一半测试集，由于本身结构相似，就又数据泄露了(不是，怎么老是泄露啊哥们，你以为你是至善园的管道吗)。</p>
<p>先按照这个想法试试，之后我得到：</p>
<div align=center><img src="output1.png" width=400/></div>
<center><font size=2>train split的分布，大概12000条</font></center>
<div align=center><img src="output2.png" width=400/></div>
<center><font size=2>validation split的分布，大概450条其实也还好</font></center>
<div align=center><img src="output3.png" width=400/></div>
<center><font size=2>test split的分布，大概660条</font></center>
<p>这样子看起来就好多了。如今2025年，我之前捣鼓下载了最新的数据集（15000+条诶！），然后导师说用23年的。但是不能白下载对不对嘿嘿，那就用25年比23年多出的这部分加入到测试集！刚好评估一下模型对未知rna的预测水平。</p>
<div align=center><img src="rnasolo.png" width=400/></div>
<center><font size=2>多了快3000条诶</font></center>
<p>除此之外，既然是评估长rna的预测水平，原先模型好像把1000+nt的rna全丢训练集了，之后看看咋改动一下？</p>

</section>


    <footer class="article-footer">
    

    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E5%BE%9C%E5%BE%89%E5%9C%A8arxiv%E5%92%8Cbioarxiv%E7%9A%84%E6%B5%B7%E6%B4%8B%E9%87%8C/">
        
        
            <div class="article-image">
                <img src="/p/%E5%BE%9C%E5%BE%89%E5%9C%A8arxiv%E5%92%8Cbioarxiv%E7%9A%84%E6%B5%B7%E6%B4%8B%E9%87%8C/1.a2a284e858a6260395fb14d5b3e3f387_hu_7b1f37f7ffa701b7.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 徜徉在arxiv和bioarxiv的海洋里"
                        
                        data-hash="md5-oqKE6FimJgOV&#43;xTVs&#43;Pzhw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">徜徉在arxiv和bioarxiv的海洋里</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 Xiangyu Wen
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<style>
  body {
    background: url(https://mosfish.github.io/background/bac.webp) no-repeat center top;
    background-size: cover;
    background-attachment: fixed;
  }
   @font-face {
    font-family: 'note';
    src: url(https://mosfish.github.io/font/suc.ttf) format('truetype');
  }

  :root {
    --base-font-family: 'note';
    --code-font-family: 'note';
  }
</style>
<style>
    .highlight {
         
        max-height: 400px;
        overflow: hidden;
    }

    .code-show {
        max-height: none !important;
    }

    .code-more-box {
        width: 100%;
        padding-top: 78px;
        background-image: -webkit-gradient(linear, left top, left bottom, from(rgba(255, 255, 255, 0)), to(#fff));
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    .code-more-btn {
        display: block;
        margin: auto;
        width: 44px;
        height: 22px;
        background: #f0f0f5;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        padding-top: 6px;
        cursor: pointer;
    }

    .code-more-img {
        cursor: pointer !important;
        display: block;
        margin: auto;
        width: 22px;
        height: 16px;
    }
</style>

<script>
  function initCodeMoreBox() {
    let codeBlocks = document.querySelectorAll(".highlight");
    if (!codeBlocks) {
      return;
    }
    codeBlocks.forEach(codeBlock => {
      
      if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
        return;
      }
      
      
      let codeMoreBox = document.createElement('div');
      codeMoreBox.classList.add('code-more-box');
      
      let codeMoreBtn = document.createElement('span');
      codeMoreBtn.classList.add('code-more-btn');
      codeMoreBtn.addEventListener('click', () => {
        codeBlock.classList.add('code-show');
        codeMoreBox.style.display = 'none';
        
        window.dispatchEvent(new Event('resize'))
      })
      
      let img = document.createElement('img');
      img.classList.add('code-more-img');
      img.src = "https://mosfish.github.io/icons/codeMore.png"
      
      codeMoreBtn.appendChild(img);
      codeMoreBox.appendChild(codeMoreBtn);
      codeBlock.appendChild(codeMoreBox)
    })
  }
  
  initCodeMoreBox();
</script>



    </body>
</html>
